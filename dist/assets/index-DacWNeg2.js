(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const $i="modulepreload",Ai=function(s){return"/"+s},On={},Le=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),d=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(t.map(h=>{if(h=Ai(h),h in On)return;On[h]=!0;const m=h.endsWith(".css"),y=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${y}`))return;const b=document.createElement("link");if(b.rel=m?"stylesheet":$i,m||(b.as="script"),b.crossOrigin="",b.href=h,d&&b.setAttribute("nonce",d),document.head.appendChild(b),m)return new Promise((_,x)=>{b.addEventListener("load",_),b.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${h}`)))})}))}function a(l){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=l,window.dispatchEvent(d),!d.defaultPrevented)throw l}return i.then(l=>{for(const d of l||[])d.status==="rejected"&&a(d.reason);return e().catch(a)})},Li=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>Le(async()=>{const{default:n}=await Promise.resolve().then(()=>Oe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)};class sn extends Error{constructor(e,t="FunctionsError",n){super(e),this.name=t,this.context=n}}class Pi extends sn{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Oi extends sn{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class ji extends sn{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var Gt;(function(s){s.Any="any",s.ApNortheast1="ap-northeast-1",s.ApNortheast2="ap-northeast-2",s.ApSouth1="ap-south-1",s.ApSoutheast1="ap-southeast-1",s.ApSoutheast2="ap-southeast-2",s.CaCentral1="ca-central-1",s.EuCentral1="eu-central-1",s.EuWest1="eu-west-1",s.EuWest2="eu-west-2",s.EuWest3="eu-west-3",s.SaEast1="sa-east-1",s.UsEast1="us-east-1",s.UsWest1="us-west-1",s.UsWest2="us-west-2"})(Gt||(Gt={}));var Bi=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};class Ui{constructor(e,{headers:t={},customFetch:n,region:i=Gt.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=Li(n)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var n;return Bi(this,void 0,void 0,function*(){try{const{headers:i,method:a,body:l}=t;let d={},{region:h}=t;h||(h=this.region),h&&h!=="any"&&(d["x-region"]=h);let m;l&&(i&&!Object.prototype.hasOwnProperty.call(i,"Content-Type")||!i)&&(typeof Blob<"u"&&l instanceof Blob||l instanceof ArrayBuffer?(d["Content-Type"]="application/octet-stream",m=l):typeof l=="string"?(d["Content-Type"]="text/plain",m=l):typeof FormData<"u"&&l instanceof FormData?m=l:(d["Content-Type"]="application/json",m=JSON.stringify(l)));const y=yield this.fetch(`${this.url}/${e}`,{method:a||"POST",headers:Object.assign(Object.assign(Object.assign({},d),this.headers),i),body:m}).catch(T=>{throw new Pi(T)}),b=y.headers.get("x-relay-error");if(b&&b==="true")throw new Oi(y);if(!y.ok)throw new ji(y);let _=((n=y.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),x;return _==="application/json"?x=yield y.json():_==="application/octet-stream"?x=yield y.blob():_==="text/event-stream"?x=y:_==="multipart/form-data"?x=yield y.formData():x=yield y.text(),{data:x,error:null}}catch(i){return{data:null,error:i}}})}}var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ta(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Di(s){if(s.__esModule)return s;var e=s.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(n){var i=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return s[n]}})}),t}var W={},rn={},lt={},Qe={},ct={},dt={},Fi=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Pe=Fi();const Mi=Pe.fetch,Yn=Pe.fetch.bind(Pe),Xn=Pe.Headers,Ni=Pe.Request,qi=Pe.Response,Oe=Object.freeze(Object.defineProperty({__proto__:null,Headers:Xn,Request:Ni,Response:qi,default:Yn,fetch:Mi},Symbol.toStringTag,{value:"Module"})),Hi=Di(Oe);var ut={};Object.defineProperty(ut,"__esModule",{value:!0});let zi=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};ut.default=zi;var Qn=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(dt,"__esModule",{value:!0});const Ji=Qn(Hi),Vi=Qn(ut);let Wi=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=Ji.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const n=this.fetch;let i=n(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async a=>{var l,d,h;let m=null,y=null,b=null,_=a.status,x=a.statusText;if(a.ok){if(this.method!=="HEAD"){const M=await a.text();M===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?y=M:y=JSON.parse(M))}const O=(l=this.headers.Prefer)===null||l===void 0?void 0:l.match(/count=(exact|planned|estimated)/),L=(d=a.headers.get("content-range"))===null||d===void 0?void 0:d.split("/");O&&L&&L.length>1&&(b=parseInt(L[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(y)&&(y.length>1?(m={code:"PGRST116",details:`Results contain ${y.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},y=null,b=null,_=406,x="Not Acceptable"):y.length===1?y=y[0]:y=null)}else{const O=await a.text();try{m=JSON.parse(O),Array.isArray(m)&&a.status===404&&(y=[],m=null,_=200,x="OK")}catch{a.status===404&&O===""?(_=204,x="No Content"):m={message:O}}if(m&&this.isMaybeSingle&&(!((h=m==null?void 0:m.details)===null||h===void 0)&&h.includes("0 rows"))&&(m=null,_=200,x="OK"),m&&this.shouldThrowOnError)throw new Vi.default(m)}return{error:m,data:y,count:b,status:_,statusText:x}});return this.shouldThrowOnError||(i=i.catch(a=>{var l,d,h;return{error:{message:`${(l=a==null?void 0:a.name)!==null&&l!==void 0?l:"FetchError"}: ${a==null?void 0:a.message}`,details:`${(d=a==null?void 0:a.stack)!==null&&d!==void 0?d:""}`,hint:"",code:`${(h=a==null?void 0:a.code)!==null&&h!==void 0?h:""}`},data:null,count:null,status:0,statusText:""}})),i.then(e,t)}returns(){return this}overrideTypes(){return this}};dt.default=Wi;var Ki=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(ct,"__esModule",{value:!0});const Gi=Ki(dt);let Yi=class extends Gi.default{select(e){let t=!1;const n=(e??"*").split("").map(i=>/\s/.test(i)&&!t?"":(i==='"'&&(t=!t),i)).join("");return this.url.searchParams.set("select",n),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:n,foreignTable:i,referencedTable:a=i}={}){const l=a?`${a}.order`:"order",d=this.url.searchParams.get(l);return this.url.searchParams.set(l,`${d?`${d},`:""}${e}.${t?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:n=t}={}){const i=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(i,`${e}`),this}range(e,t,{foreignTable:n,referencedTable:i=n}={}){const a=typeof i>"u"?"offset":`${i}.offset`,l=typeof i>"u"?"limit":`${i}.limit`;return this.url.searchParams.set(a,`${e}`),this.url.searchParams.set(l,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:n=!1,buffers:i=!1,wal:a=!1,format:l="text"}={}){var d;const h=[e?"analyze":null,t?"verbose":null,n?"settings":null,i?"buffers":null,a?"wal":null].filter(Boolean).join("|"),m=(d=this.headers.Accept)!==null&&d!==void 0?d:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${l}; for="${m}"; options=${h};`,l==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}};ct.default=Yi;var Xi=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(Qe,"__esModule",{value:!0});const Qi=Xi(ct);let Zi=class extends Qi.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const n=Array.from(new Set(t)).map(i=>typeof i=="string"&&new RegExp("[,()]").test(i)?`"${i}"`:`${i}`).join(",");return this.url.searchParams.append(e,`in.(${n})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:n,type:i}={}){let a="";i==="plain"?a="pl":i==="phrase"?a="ph":i==="websearch"&&(a="w");const l=n===void 0?"":`(${n})`;return this.url.searchParams.append(e,`${a}fts${l}.${t}`),this}match(e){return Object.entries(e).forEach(([t,n])=>{this.url.searchParams.append(t,`eq.${n}`)}),this}not(e,t,n){return this.url.searchParams.append(e,`not.${t}.${n}`),this}or(e,{foreignTable:t,referencedTable:n=t}={}){const i=n?`${n}.or`:"or";return this.url.searchParams.append(i,`(${e})`),this}filter(e,t,n){return this.url.searchParams.append(e,`${t}.${n}`),this}};Qe.default=Zi;var er=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(lt,"__esModule",{value:!0});const Je=er(Qe);let tr=class{constructor(e,{headers:t={},schema:n,fetch:i}){this.url=e,this.headers=t,this.schema=n,this.fetch=i}select(e,{head:t=!1,count:n}={}){const i=t?"HEAD":"GET";let a=!1;const l=(e??"*").split("").map(d=>/\s/.test(d)&&!a?"":(d==='"'&&(a=!a),d)).join("");return this.url.searchParams.set("select",l),n&&(this.headers.Prefer=`count=${n}`),new Je.default({method:i,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:n=!0}={}){const i="POST",a=[];if(this.headers.Prefer&&a.push(this.headers.Prefer),t&&a.push(`count=${t}`),n||a.push("missing=default"),this.headers.Prefer=a.join(","),Array.isArray(e)){const l=e.reduce((d,h)=>d.concat(Object.keys(h)),[]);if(l.length>0){const d=[...new Set(l)].map(h=>`"${h}"`);this.url.searchParams.set("columns",d.join(","))}}return new Je.default({method:i,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:n=!1,count:i,defaultToNull:a=!0}={}){const l="POST",d=[`resolution=${n?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&d.push(this.headers.Prefer),i&&d.push(`count=${i}`),a||d.push("missing=default"),this.headers.Prefer=d.join(","),Array.isArray(e)){const h=e.reduce((m,y)=>m.concat(Object.keys(y)),[]);if(h.length>0){const m=[...new Set(h)].map(y=>`"${y}"`);this.url.searchParams.set("columns",m.join(","))}}return new Je.default({method:l,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const n="PATCH",i=[];return this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),this.headers.Prefer=i.join(","),new Je.default({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",n=[];return e&&n.push(`count=${e}`),this.headers.Prefer&&n.unshift(this.headers.Prefer),this.headers.Prefer=n.join(","),new Je.default({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}};lt.default=tr;var ht={},ft={};Object.defineProperty(ft,"__esModule",{value:!0});ft.version=void 0;ft.version="0.0.0-automated";Object.defineProperty(ht,"__esModule",{value:!0});ht.DEFAULT_HEADERS=void 0;const nr=ft;ht.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${nr.version}`};var Zn=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(rn,"__esModule",{value:!0});const sr=Zn(lt),ir=Zn(Qe),rr=ht;let or=class es{constructor(e,{headers:t={},schema:n,fetch:i}={}){this.url=e,this.headers=Object.assign(Object.assign({},rr.DEFAULT_HEADERS),t),this.schemaName=n,this.fetch=i}from(e){const t=new URL(`${this.url}/${e}`);return new sr.default(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new es(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:n=!1,get:i=!1,count:a}={}){let l;const d=new URL(`${this.url}/rpc/${e}`);let h;n||i?(l=n?"HEAD":"GET",Object.entries(t).filter(([y,b])=>b!==void 0).map(([y,b])=>[y,Array.isArray(b)?`{${b.join(",")}}`:`${b}`]).forEach(([y,b])=>{d.searchParams.append(y,b)})):(l="POST",h=t);const m=Object.assign({},this.headers);return a&&(m.Prefer=`count=${a}`),new ir.default({method:l,url:d,headers:m,schema:this.schemaName,body:h,fetch:this.fetch,allowEmpty:!1})}};rn.default=or;var je=X&&X.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(W,"__esModule",{value:!0});W.PostgrestError=W.PostgrestBuilder=W.PostgrestTransformBuilder=W.PostgrestFilterBuilder=W.PostgrestQueryBuilder=W.PostgrestClient=void 0;const ts=je(rn);W.PostgrestClient=ts.default;const ns=je(lt);W.PostgrestQueryBuilder=ns.default;const ss=je(Qe);W.PostgrestFilterBuilder=ss.default;const is=je(ct);W.PostgrestTransformBuilder=is.default;const rs=je(dt);W.PostgrestBuilder=rs.default;const os=je(ut);W.PostgrestError=os.default;var ar=W.default={PostgrestClient:ts.default,PostgrestQueryBuilder:ns.default,PostgrestFilterBuilder:ss.default,PostgrestTransformBuilder:is.default,PostgrestBuilder:rs.default,PostgrestError:os.default};const{PostgrestClient:lr,PostgrestQueryBuilder:aa,PostgrestFilterBuilder:la,PostgrestTransformBuilder:ca,PostgrestBuilder:da,PostgrestError:ua}=ar,cr="2.11.2",dr={"X-Client-Info":`realtime-js/${cr}`},ur="1.0.0",as=1e4,hr=1e3;var Ae;(function(s){s[s.connecting=0]="connecting",s[s.open=1]="open",s[s.closing=2]="closing",s[s.closed=3]="closed"})(Ae||(Ae={}));var K;(function(s){s.closed="closed",s.errored="errored",s.joined="joined",s.joining="joining",s.leaving="leaving"})(K||(K={}));var ne;(function(s){s.close="phx_close",s.error="phx_error",s.join="phx_join",s.reply="phx_reply",s.leave="phx_leave",s.access_token="access_token"})(ne||(ne={}));var Yt;(function(s){s.websocket="websocket"})(Yt||(Yt={}));var ve;(function(s){s.Connecting="connecting",s.Open="open",s.Closing="closing",s.Closed="closed"})(ve||(ve={}));class fr{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),n=new TextDecoder;return this._decodeBroadcast(e,t,n)}_decodeBroadcast(e,t,n){const i=t.getUint8(1),a=t.getUint8(2);let l=this.HEADER_LENGTH+2;const d=n.decode(e.slice(l,l+i));l=l+i;const h=n.decode(e.slice(l,l+a));l=l+a;const m=JSON.parse(n.decode(e.slice(l,e.byteLength)));return{ref:null,topic:d,event:h,payload:m}}}class ls{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var j;(function(s){s.abstime="abstime",s.bool="bool",s.date="date",s.daterange="daterange",s.float4="float4",s.float8="float8",s.int2="int2",s.int4="int4",s.int4range="int4range",s.int8="int8",s.int8range="int8range",s.json="json",s.jsonb="jsonb",s.money="money",s.numeric="numeric",s.oid="oid",s.reltime="reltime",s.text="text",s.time="time",s.timestamp="timestamp",s.timestamptz="timestamptz",s.timetz="timetz",s.tsrange="tsrange",s.tstzrange="tstzrange"})(j||(j={}));const jn=(s,e,t={})=>{var n;const i=(n=t.skipTypes)!==null&&n!==void 0?n:[];return Object.keys(e).reduce((a,l)=>(a[l]=gr(l,s,e,i),a),{})},gr=(s,e,t,n)=>{const i=e.find(d=>d.name===s),a=i==null?void 0:i.type,l=t[s];return a&&!n.includes(a)?cs(a,l):Xt(l)},cs=(s,e)=>{if(s.charAt(0)==="_"){const t=s.slice(1,s.length);return vr(e,t)}switch(s){case j.bool:return pr(e);case j.float4:case j.float8:case j.int2:case j.int4:case j.int8:case j.numeric:case j.oid:return mr(e);case j.json:case j.jsonb:return yr(e);case j.timestamp:return wr(e);case j.abstime:case j.date:case j.daterange:case j.int4range:case j.int8range:case j.money:case j.reltime:case j.text:case j.time:case j.timestamptz:case j.timetz:case j.tsrange:case j.tstzrange:return Xt(e);default:return Xt(e)}},Xt=s=>s,pr=s=>{switch(s){case"t":return!0;case"f":return!1;default:return s}},mr=s=>{if(typeof s=="string"){const e=parseFloat(s);if(!Number.isNaN(e))return e}return s},yr=s=>{if(typeof s=="string")try{return JSON.parse(s)}catch(e){return console.log(`JSON parse error: ${e}`),s}return s},vr=(s,e)=>{if(typeof s!="string")return s;const t=s.length-1,n=s[t];if(s[0]==="{"&&n==="}"){let a;const l=s.slice(1,t);try{a=JSON.parse("["+l+"]")}catch{a=l?l.split(","):[]}return a.map(d=>cs(e,d))}return s},wr=s=>typeof s=="string"?s.replace(" ","T"):s,ds=s=>{let e=s;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class Ht{constructor(e,t,n={},i=as){this.channel=e,this.event=t,this.payload=n,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var n;return this._hasReceived(e)&&t((n=this.receivedResp)===null||n===void 0?void 0:n.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Bn;(function(s){s.SYNC="sync",s.JOIN="join",s.LEAVE="leave"})(Bn||(Bn={}));class We{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const n=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(n.state,{},i=>{const{onJoin:a,onLeave:l,onSync:d}=this.caller;this.joinRef=this.channel._joinRef(),this.state=We.syncState(this.state,i,a,l),this.pendingDiffs.forEach(h=>{this.state=We.syncDiff(this.state,h,a,l)}),this.pendingDiffs=[],d()}),this.channel._on(n.diff,{},i=>{const{onJoin:a,onLeave:l,onSync:d}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=We.syncDiff(this.state,i,a,l),d())}),this.onJoin((i,a,l)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:a,newPresences:l})}),this.onLeave((i,a,l)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:a,leftPresences:l})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,n,i){const a=this.cloneDeep(e),l=this.transformState(t),d={},h={};return this.map(a,(m,y)=>{l[m]||(h[m]=y)}),this.map(l,(m,y)=>{const b=a[m];if(b){const _=y.map(L=>L.presence_ref),x=b.map(L=>L.presence_ref),T=y.filter(L=>x.indexOf(L.presence_ref)<0),O=b.filter(L=>_.indexOf(L.presence_ref)<0);T.length>0&&(d[m]=T),O.length>0&&(h[m]=O)}else d[m]=y}),this.syncDiff(a,{joins:d,leaves:h},n,i)}static syncDiff(e,t,n,i){const{joins:a,leaves:l}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return n||(n=()=>{}),i||(i=()=>{}),this.map(a,(d,h)=>{var m;const y=(m=e[d])!==null&&m!==void 0?m:[];if(e[d]=this.cloneDeep(h),y.length>0){const b=e[d].map(x=>x.presence_ref),_=y.filter(x=>b.indexOf(x.presence_ref)<0);e[d].unshift(..._)}n(d,y,h)}),this.map(l,(d,h)=>{let m=e[d];if(!m)return;const y=h.map(b=>b.presence_ref);m=m.filter(b=>y.indexOf(b.presence_ref)<0),e[d]=m,i(d,m,h),m.length===0&&delete e[d]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(n=>t(n,e[n]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,n)=>{const i=e[n];return"metas"in i?t[n]=i.metas.map(a=>(a.presence_ref=a.phx_ref,delete a.phx_ref,delete a.phx_ref_prev,a)):t[n]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Un;(function(s){s.ALL="*",s.INSERT="INSERT",s.UPDATE="UPDATE",s.DELETE="DELETE"})(Un||(Un={}));var Dn;(function(s){s.BROADCAST="broadcast",s.PRESENCE="presence",s.POSTGRES_CHANGES="postgres_changes",s.SYSTEM="system"})(Dn||(Dn={}));var oe;(function(s){s.SUBSCRIBED="SUBSCRIBED",s.TIMED_OUT="TIMED_OUT",s.CLOSED="CLOSED",s.CHANNEL_ERROR="CHANNEL_ERROR"})(oe||(oe={}));class on{constructor(e,t={config:{}},n){this.topic=e,this.params=t,this.socket=n,this.bindings={},this.state=K.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Ht(this,ne.join,this.params,this.timeout),this.rejoinTimer=new ls(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=K.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=K.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=K.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=K.errored,this.rejoinTimer.scheduleTimeout())}),this._on(ne.reply,{},(i,a)=>{this._trigger(this._replyEventName(a),i)}),this.presence=new We(this),this.broadcastEndpointURL=ds(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var n,i;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:a,presence:l,private:d}}=this.params;this._onError(y=>e==null?void 0:e(oe.CHANNEL_ERROR,y)),this._onClose(()=>e==null?void 0:e(oe.CLOSED));const h={},m={broadcast:a,presence:l,postgres_changes:(i=(n=this.bindings.postgres_changes)===null||n===void 0?void 0:n.map(y=>y.filter))!==null&&i!==void 0?i:[],private:d};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:m},h)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:y})=>{var b;if(this.socket.setAuth(),y===void 0){e==null||e(oe.SUBSCRIBED);return}else{const _=this.bindings.postgres_changes,x=(b=_==null?void 0:_.length)!==null&&b!==void 0?b:0,T=[];for(let O=0;O<x;O++){const L=_[O],{filter:{event:M,schema:G,table:q,filter:H}}=L,J=y&&y[O];if(J&&J.event===M&&J.schema===G&&J.table===q&&J.filter===H)T.push(Object.assign(Object.assign({},L),{id:J.id}));else{this.unsubscribe(),e==null||e(oe.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=T,e&&e(oe.SUBSCRIBED);return}}).receive("error",y=>{e==null||e(oe.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(y).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(oe.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,n){return this._on(e,t,n)}async send(e,t={}){var n,i;if(!this._canPush()&&e.type==="broadcast"){const{event:a,payload:l}=e,h={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:a,payload:l,private:this.private}]})};try{const m=await this._fetchWithTimeout(this.broadcastEndpointURL,h,(n=t.timeout)!==null&&n!==void 0?n:this.timeout);return await((i=m.body)===null||i===void 0?void 0:i.cancel()),m.ok?"ok":"error"}catch(m){return m.name==="AbortError"?"timed out":"error"}}else return new Promise(a=>{var l,d,h;const m=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((h=(d=(l=this.params)===null||l===void 0?void 0:l.config)===null||d===void 0?void 0:d.broadcast)===null||h===void 0)&&h.ack)&&a("ok"),m.receive("ok",()=>a("ok")),m.receive("error",()=>a("error")),m.receive("timeout",()=>a("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=K.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(ne.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(n=>{const i=new Ht(this,ne.leave,{},e);i.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),i.send(),this._canPush()||i.trigger("ok",{})})}async _fetchWithTimeout(e,t,n){const i=new AbortController,a=setTimeout(()=>i.abort(),n),l=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(a),l}_push(e,t,n=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new Ht(this,e,t,n);return this._canPush()?i.send():(i.startTimeout(),this.pushBuffer.push(i)),i}_onMessage(e,t,n){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,n){var i,a;const l=e.toLocaleLowerCase(),{close:d,error:h,leave:m,join:y}=ne;if(n&&[d,h,m,y].indexOf(l)>=0&&n!==this._joinRef())return;let _=this._onMessage(l,t,n);if(t&&!_)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(l)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(x=>{var T,O,L;return((T=x.filter)===null||T===void 0?void 0:T.event)==="*"||((L=(O=x.filter)===null||O===void 0?void 0:O.event)===null||L===void 0?void 0:L.toLocaleLowerCase())===l}).map(x=>x.callback(_,n)):(a=this.bindings[l])===null||a===void 0||a.filter(x=>{var T,O,L,M,G,q;if(["broadcast","presence","postgres_changes"].includes(l))if("id"in x){const H=x.id,J=(T=x.filter)===null||T===void 0?void 0:T.event;return H&&((O=t.ids)===null||O===void 0?void 0:O.includes(H))&&(J==="*"||(J==null?void 0:J.toLocaleLowerCase())===((L=t.data)===null||L===void 0?void 0:L.type.toLocaleLowerCase()))}else{const H=(G=(M=x==null?void 0:x.filter)===null||M===void 0?void 0:M.event)===null||G===void 0?void 0:G.toLocaleLowerCase();return H==="*"||H===((q=t==null?void 0:t.event)===null||q===void 0?void 0:q.toLocaleLowerCase())}else return x.type.toLocaleLowerCase()===l}).map(x=>{if(typeof _=="object"&&"ids"in _){const T=_.data,{schema:O,table:L,commit_timestamp:M,type:G,errors:q}=T;_=Object.assign(Object.assign({},{schema:O,table:L,commit_timestamp:M,eventType:G,new:{},old:{},errors:q}),this._getPayloadRecords(T))}x.callback(_,n)})}_isClosed(){return this.state===K.closed}_isJoined(){return this.state===K.joined}_isJoining(){return this.state===K.joining}_isLeaving(){return this.state===K.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,n){const i=e.toLocaleLowerCase(),a={type:i,filter:t,callback:n};return this.bindings[i]?this.bindings[i].push(a):this.bindings[i]=[a],this}_off(e,t){const n=e.toLocaleLowerCase();return this.bindings[n]=this.bindings[n].filter(i=>{var a;return!(((a=i.type)===null||a===void 0?void 0:a.toLocaleLowerCase())===n&&on.isEqual(i.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(ne.close,{},e)}_onError(e){this._on(ne.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=K.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=jn(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=jn(e.columns,e.old_record)),t}}const br=()=>{},_r=typeof WebSocket<"u",Er=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class kr{constructor(e,t){var n;this.accessTokenValue=null,this.apiKey=null,this.channels=[],this.endPoint="",this.httpEndpoint="",this.headers=dr,this.params={},this.timeout=as,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=br,this.conn=null,this.sendBuffer=[],this.serializer=new fr,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=a=>{let l;return a?l=a:typeof fetch>"u"?l=(...d)=>Le(async()=>{const{default:h}=await Promise.resolve().then(()=>Oe);return{default:h}},void 0).then(({default:h})=>h(...d)):l=fetch,(...d)=>l(...d)},this.endPoint=`${e}/${Yt.websocket}`,this.httpEndpoint=ds(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const i=(n=t==null?void 0:t.params)===null||n===void 0?void 0:n.apikey;if(i&&(this.accessTokenValue=i,this.apiKey=i),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:a=>[1e3,2e3,5e3,1e4][a-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(a,l)=>l(JSON.stringify(a)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new ls(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this.endpointURL(),void 0,{headers:this.headers});return}if(_r){this.conn=new WebSocket(this.endpointURL()),this.setupConnection();return}this.conn=new Ir(this.endpointURL(),void 0,{close:()=>{this.conn=null}}),Le(async()=>{const{default:e}=await import("./browser-Bmm0v5r5.js").then(t=>t.b);return{default:e}},[]).then(({default:e})=>{this.conn=new e(this.endpointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:ur}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,n){this.logger(e,t,n)}connectionState(){switch(this.conn&&this.conn.readyState){case Ae.connecting:return ve.Connecting;case Ae.open:return ve.Open;case Ae.closing:return ve.Closing;default:return ve.Closed}}isConnected(){return this.connectionState()===ve.Open}channel(e,t={config:{}}){const n=new on(`realtime:${e}`,t,this);return this.channels.push(n),n}push(e){const{topic:t,event:n,payload:i,ref:a}=e,l=()=>{this.encode(e,d=>{var h;(h=this.conn)===null||h===void 0||h.send(d)})};this.log("push",`${t} ${n} (${a})`,i),this.isConnected()?l():this.sendBuffer.push(l)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;if(t){let n=null;try{n=JSON.parse(atob(t.split(".")[1]))}catch{}if(n&&n.exp&&!(Math.floor(Date.now()/1e3)-n.exp<0))return this.log("auth",`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${n.exp}`),Promise.reject(`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${n.exp}`);this.accessTokenValue=t,this.channels.forEach(i=>{t&&i.updateJoinPayload({access_token:t}),i.joinedOnce&&i._isJoined()&&i._push(ne.access_token,{access_token:t})})}}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(hr,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth()}}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(n=>n.topic===e&&(n._isJoined()||n._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:n,event:i,payload:a,ref:l}=t;l&&l===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${a.status||""} ${n} ${i} ${l&&"("+l+")"||""}`,a),this.channels.filter(d=>d._isMember(n)).forEach(d=>d._trigger(i,a,l)),this.stateChangeCallbacks.message.forEach(d=>d(t))})}async _onConnOpen(){if(this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),!this.worker)this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs);else{this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(ne.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const n=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${n}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const n=new Blob([Er],{type:"application/javascript"});t=URL.createObjectURL(n)}return t}}class Ir{constructor(e,t,n){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=Ae.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=n.close}}class an extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function N(s){return typeof s=="object"&&s!==null&&"__isStorageError"in s}class Sr extends an{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Qt extends an{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var xr=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};const us=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>Le(async()=>{const{default:n}=await Promise.resolve().then(()=>Oe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},Cr=()=>xr(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield Le(()=>Promise.resolve().then(()=>Oe),void 0)).Response:Response}),Zt=s=>{if(Array.isArray(s))return s.map(t=>Zt(t));if(typeof s=="function"||s!==Object(s))return s;const e={};return Object.entries(s).forEach(([t,n])=>{const i=t.replace(/([-_][a-z])/gi,a=>a.toUpperCase().replace(/[-_]/g,""));e[i]=Zt(n)}),e};var we=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};const zt=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Rr=(s,e,t)=>we(void 0,void 0,void 0,function*(){const n=yield Cr();s instanceof n&&!(t!=null&&t.noResolveJson)?s.json().then(i=>{e(new Sr(zt(i),s.status||500))}).catch(i=>{e(new Qt(zt(i),i))}):e(new Qt(zt(s),s))}),Tr=(s,e,t,n)=>{const i={method:s,headers:(e==null?void 0:e.headers)||{}};return s==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),n&&(i.body=JSON.stringify(n)),Object.assign(Object.assign({},i),t))};function Ze(s,e,t,n,i,a){return we(this,void 0,void 0,function*(){return new Promise((l,d)=>{s(t,Tr(e,n,i,a)).then(h=>{if(!h.ok)throw h;return n!=null&&n.noResolveJson?h:h.json()}).then(h=>l(h)).catch(h=>Rr(h,d,n))})})}function at(s,e,t,n){return we(this,void 0,void 0,function*(){return Ze(s,"GET",e,t,n)})}function de(s,e,t,n,i){return we(this,void 0,void 0,function*(){return Ze(s,"POST",e,n,i,t)})}function $r(s,e,t,n,i){return we(this,void 0,void 0,function*(){return Ze(s,"PUT",e,n,i,t)})}function Ar(s,e,t,n){return we(this,void 0,void 0,function*(){return Ze(s,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),n)})}function hs(s,e,t,n,i){return we(this,void 0,void 0,function*(){return Ze(s,"DELETE",e,n,i,t)})}var V=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};const Lr={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Fn={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Pr{constructor(e,t={},n,i){this.url=e,this.headers=t,this.bucketId=n,this.fetch=us(i)}uploadOrUpdate(e,t,n,i){return V(this,void 0,void 0,function*(){try{let a;const l=Object.assign(Object.assign({},Fn),i);let d=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(l.upsert)});const h=l.metadata;typeof Blob<"u"&&n instanceof Blob?(a=new FormData,a.append("cacheControl",l.cacheControl),h&&a.append("metadata",this.encodeMetadata(h)),a.append("",n)):typeof FormData<"u"&&n instanceof FormData?(a=n,a.append("cacheControl",l.cacheControl),h&&a.append("metadata",this.encodeMetadata(h))):(a=n,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType,h&&(d["x-metadata"]=this.toBase64(this.encodeMetadata(h)))),i!=null&&i.headers&&(d=Object.assign(Object.assign({},d),i.headers));const m=this._removeEmptyFolders(t),y=this._getFinalPath(m),b=yield this.fetch(`${this.url}/object/${y}`,Object.assign({method:e,body:a,headers:d},l!=null&&l.duplex?{duplex:l.duplex}:{})),_=yield b.json();return b.ok?{data:{path:m,id:_.Id,fullPath:_.Key},error:null}:{data:null,error:_}}catch(a){if(N(a))return{data:null,error:a};throw a}})}upload(e,t,n){return V(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,n)})}uploadToSignedUrl(e,t,n,i){return V(this,void 0,void 0,function*(){const a=this._removeEmptyFolders(e),l=this._getFinalPath(a),d=new URL(this.url+`/object/upload/sign/${l}`);d.searchParams.set("token",t);try{let h;const m=Object.assign({upsert:Fn.upsert},i),y=Object.assign(Object.assign({},this.headers),{"x-upsert":String(m.upsert)});typeof Blob<"u"&&n instanceof Blob?(h=new FormData,h.append("cacheControl",m.cacheControl),h.append("",n)):typeof FormData<"u"&&n instanceof FormData?(h=n,h.append("cacheControl",m.cacheControl)):(h=n,y["cache-control"]=`max-age=${m.cacheControl}`,y["content-type"]=m.contentType);const b=yield this.fetch(d.toString(),{method:"PUT",body:h,headers:y}),_=yield b.json();return b.ok?{data:{path:a,fullPath:_.Key},error:null}:{data:null,error:_}}catch(h){if(N(h))return{data:null,error:h};throw h}})}createSignedUploadUrl(e,t){return V(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e);const i=Object.assign({},this.headers);t!=null&&t.upsert&&(i["x-upsert"]="true");const a=yield de(this.fetch,`${this.url}/object/upload/sign/${n}`,{},{headers:i}),l=new URL(this.url+a.url),d=l.searchParams.get("token");if(!d)throw new an("No token returned by API");return{data:{signedUrl:l.toString(),path:e,token:d},error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}update(e,t,n){return V(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,n)})}move(e,t,n){return V(this,void 0,void 0,function*(){try{return{data:yield de(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n==null?void 0:n.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}copy(e,t,n){return V(this,void 0,void 0,function*(){try{return{data:{path:(yield de(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n==null?void 0:n.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,n){return V(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),a=yield de(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},n!=null&&n.transform?{transform:n.transform}:{}),{headers:this.headers});const l=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return a={signedUrl:encodeURI(`${this.url}${a.signedURL}${l}`)},{data:a,error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,n){return V(this,void 0,void 0,function*(){try{const i=yield de(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),a=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return{data:i.map(l=>Object.assign(Object.assign({},l),{signedUrl:l.signedURL?encodeURI(`${this.url}${l.signedURL}${a}`):null})),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}download(e,t){return V(this,void 0,void 0,function*(){const i=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",a=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),l=a?`?${a}`:"";try{const d=this._getFinalPath(e);return{data:yield(yield at(this.fetch,`${this.url}/${i}/${d}${l}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(d){if(N(d))return{data:null,error:d};throw d}})}info(e){return V(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const n=yield at(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Zt(n),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}exists(e){return V(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Ar(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(n){if(N(n)&&n instanceof Qt){const i=n.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:n}}throw n}})}getPublicUrl(e,t){const n=this._getFinalPath(e),i=[],a=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";a!==""&&i.push(a);const d=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",h=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});h!==""&&i.push(h);let m=i.join("&");return m!==""&&(m=`?${m}`),{data:{publicUrl:encodeURI(`${this.url}/${d}/public/${n}${m}`)}}}remove(e){return V(this,void 0,void 0,function*(){try{return{data:yield hs(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}list(e,t,n){return V(this,void 0,void 0,function*(){try{const i=Object.assign(Object.assign(Object.assign({},Lr),t),{prefix:e||""});return{data:yield de(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},n),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Or="2.7.1",jr={"X-Client-Info":`storage-js/${Or}`};var Ce=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};class Br{constructor(e,t={},n){this.url=e,this.headers=Object.assign(Object.assign({},jr),t),this.fetch=us(n)}listBuckets(){return Ce(this,void 0,void 0,function*(){try{return{data:yield at(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(N(e))return{data:null,error:e};throw e}})}getBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield at(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return Ce(this,void 0,void 0,function*(){try{return{data:yield de(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}updateBucket(e,t){return Ce(this,void 0,void 0,function*(){try{return{data:yield $r(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}emptyBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield de(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield hs(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}}class Ur extends Br{constructor(e,t={},n){super(e,t,n)}from(e){return new Pr(this.url,this.headers,e,this.fetch)}}const Dr="2.49.8";let Ve="";typeof Deno<"u"?Ve="deno":typeof document<"u"?Ve="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Ve="react-native":Ve="node";const Fr={"X-Client-Info":`supabase-js-${Ve}/${Dr}`},Mr={headers:Fr},Nr={schema:"public"},qr={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Hr={};var zr=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};const Jr=s=>{let e;return s?e=s:typeof fetch>"u"?e=Yn:e=fetch,(...t)=>e(...t)},Vr=()=>typeof Headers>"u"?Xn:Headers,Wr=(s,e,t)=>{const n=Jr(t),i=Vr();return(a,l)=>zr(void 0,void 0,void 0,function*(){var d;const h=(d=yield e())!==null&&d!==void 0?d:s;let m=new i(l==null?void 0:l.headers);return m.has("apikey")||m.set("apikey",s),m.has("Authorization")||m.set("Authorization",`Bearer ${h}`),n(a,Object.assign(Object.assign({},l),{headers:m}))})};var Kr=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};function Gr(s){return s.endsWith("/")?s:s+"/"}function Yr(s,e){var t,n;const{db:i,auth:a,realtime:l,global:d}=s,{db:h,auth:m,realtime:y,global:b}=e,_={db:Object.assign(Object.assign({},h),i),auth:Object.assign(Object.assign({},m),a),realtime:Object.assign(Object.assign({},y),l),global:Object.assign(Object.assign(Object.assign({},b),d),{headers:Object.assign(Object.assign({},(t=b==null?void 0:b.headers)!==null&&t!==void 0?t:{}),(n=d==null?void 0:d.headers)!==null&&n!==void 0?n:{})}),accessToken:()=>Kr(this,void 0,void 0,function*(){return""})};return s.accessToken?_.accessToken=s.accessToken:delete _.accessToken,_}const fs="2.69.1",$e=30*1e3,en=3,Jt=en*$e,Xr="http://localhost:9999",Qr="supabase.auth.token",Zr={"X-Client-Info":`gotrue-js/${fs}`},tn="X-Supabase-Api-Version",gs={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},eo=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,to=6e5;class ln extends Error{constructor(e,t,n){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=n}}function C(s){return typeof s=="object"&&s!==null&&"__isAuthError"in s}class no extends ln{constructor(e,t,n){super(e,t,n),this.name="AuthApiError",this.status=t,this.code=n}}function so(s){return C(s)&&s.name==="AuthApiError"}class ps extends ln{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class he extends ln{constructor(e,t,n,i){super(e,n,i),this.name=t,this.status=n}}class le extends he{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function io(s){return C(s)&&s.name==="AuthSessionMissingError"}class Vt extends he{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class st extends he{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class it extends he{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function ro(s){return C(s)&&s.name==="AuthImplicitGrantRedirectError"}class Mn extends he{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class nn extends he{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Wt(s){return C(s)&&s.name==="AuthRetryableFetchError"}class Nn extends he{constructor(e,t,n){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=n}}class Ke extends he{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const qn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Hn=` 	
\r=`.split(""),oo=(()=>{const s=new Array(128);for(let e=0;e<s.length;e+=1)s[e]=-1;for(let e=0;e<Hn.length;e+=1)s[Hn[e].charCodeAt(0)]=-2;for(let e=0;e<qn.length;e+=1)s[qn[e].charCodeAt(0)]=e;return s})();function ms(s,e,t){const n=oo[s];if(n>-1)for(e.queue=e.queue<<6|n,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(n===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(s)}"`)}}function zn(s){const e=[],t=l=>{e.push(String.fromCodePoint(l))},n={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},a=l=>{co(l,n,t)};for(let l=0;l<s.length;l+=1)ms(s.charCodeAt(l),i,a);return e.join("")}function ao(s,e){if(s<=127){e(s);return}else if(s<=2047){e(192|s>>6),e(128|s&63);return}else if(s<=65535){e(224|s>>12),e(128|s>>6&63),e(128|s&63);return}else if(s<=1114111){e(240|s>>18),e(128|s>>12&63),e(128|s>>6&63),e(128|s&63);return}throw new Error(`Unrecognized Unicode codepoint: ${s.toString(16)}`)}function lo(s,e){for(let t=0;t<s.length;t+=1){let n=s.charCodeAt(t);if(n>55295&&n<=56319){const i=(n-55296)*1024&65535;n=(s.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}ao(n,e)}}function co(s,e,t){if(e.utf8seq===0){if(s<=127){t(s);return}for(let n=1;n<6;n+=1)if(!(s>>7-n&1)){e.utf8seq=n;break}if(e.utf8seq===2)e.codepoint=s&31;else if(e.utf8seq===3)e.codepoint=s&15;else if(e.utf8seq===4)e.codepoint=s&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(s<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|s&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function uo(s){const e=[],t={queue:0,queuedBits:0},n=i=>{e.push(i)};for(let i=0;i<s.length;i+=1)ms(s.charCodeAt(i),t,n);return new Uint8Array(e)}function ho(s){const e=[];return lo(s,t=>e.push(t)),new Uint8Array(e)}function fo(s){return Math.round(Date.now()/1e3)+s}function go(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s=="x"?e:e&3|8).toString(16)})}const ie=()=>typeof window<"u"&&typeof document<"u",me={tested:!1,writable:!1},Ge=()=>{if(!ie())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(me.tested)return me.writable;const s=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(s,s),globalThis.localStorage.removeItem(s),me.tested=!0,me.writable=!0}catch{me.tested=!0,me.writable=!1}return me.writable};function po(s){const e={},t=new URL(s);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,a)=>{e[a]=i})}catch{}return t.searchParams.forEach((n,i)=>{e[i]=n}),e}const ys=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>Le(async()=>{const{default:n}=await Promise.resolve().then(()=>Oe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},mo=s=>typeof s=="object"&&s!==null&&"status"in s&&"ok"in s&&"json"in s&&typeof s.json=="function",vs=async(s,e,t)=>{await s.setItem(e,JSON.stringify(t))},rt=async(s,e)=>{const t=await s.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},ot=async(s,e)=>{await s.removeItem(e)};class gt{constructor(){this.promise=new gt.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}gt.promiseConstructor=Promise;function Kt(s){const e=s.split(".");if(e.length!==3)throw new Ke("Invalid JWT structure");for(let n=0;n<e.length;n++)if(!eo.test(e[n]))throw new Ke("JWT not in base64url format");return{header:JSON.parse(zn(e[0])),payload:JSON.parse(zn(e[1])),signature:uo(e[2]),raw:{header:e[0],payload:e[1]}}}async function yo(s){return await new Promise(e=>{setTimeout(()=>e(null),s)})}function vo(s,e){return new Promise((n,i)=>{(async()=>{for(let a=0;a<1/0;a++)try{const l=await s(a);if(!e(a,null,l)){n(l);return}}catch(l){if(!e(a,l)){i(l);return}}})()})}function wo(s){return("0"+s.toString(16)).substr(-2)}function bo(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=t.length;let i="";for(let a=0;a<56;a++)i+=t.charAt(Math.floor(Math.random()*n));return i}return crypto.getRandomValues(e),Array.from(e,wo).join("")}async function _o(s){const t=new TextEncoder().encode(s),n=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(n);return Array.from(i).map(a=>String.fromCharCode(a)).join("")}async function Eo(s){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),s;const t=await _o(s);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Re(s,e,t=!1){const n=bo();let i=n;t&&(i+="/PASSWORD_RECOVERY"),await vs(s,`${e}-code-verifier`,i);const a=await Eo(n);return[a,n===a?"plain":"s256"]}const ko=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Io(s){const e=s.headers.get(tn);if(!e||!e.match(ko))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function So(s){if(!s)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(s<=e)throw new Error("JWT has expired")}function xo(s){switch(s){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}var Co=function(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(s);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(s,n[i])&&(t[n[i]]=s[n[i]]);return t};const ye=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Ro=[502,503,504];async function Jn(s){var e;if(!mo(s))throw new nn(ye(s),0);if(Ro.includes(s.status))throw new nn(ye(s),s.status);let t;try{t=await s.json()}catch(a){throw new ps(ye(a),a)}let n;const i=Io(s);if(i&&i.getTime()>=gs["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?n=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(n=t.error_code),n){if(n==="weak_password")throw new Nn(ye(t),s.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(n==="session_not_found")throw new le}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((a,l)=>a&&typeof l=="string",!0))throw new Nn(ye(t),s.status,t.weak_password.reasons);throw new no(ye(t),s.status||500,n)}const To=(s,e,t,n)=>{const i={method:s,headers:(e==null?void 0:e.headers)||{}};return s==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(n),Object.assign(Object.assign({},i),t))};async function $(s,e,t,n){var i;const a=Object.assign({},n==null?void 0:n.headers);a[tn]||(a[tn]=gs["2024-01-01"].name),n!=null&&n.jwt&&(a.Authorization=`Bearer ${n.jwt}`);const l=(i=n==null?void 0:n.query)!==null&&i!==void 0?i:{};n!=null&&n.redirectTo&&(l.redirect_to=n.redirectTo);const d=Object.keys(l).length?"?"+new URLSearchParams(l).toString():"",h=await $o(s,e,t+d,{headers:a,noResolveJson:n==null?void 0:n.noResolveJson},{},n==null?void 0:n.body);return n!=null&&n.xform?n==null?void 0:n.xform(h):{data:Object.assign({},h),error:null}}async function $o(s,e,t,n,i,a){const l=To(e,n,i,a);let d;try{d=await s(t,Object.assign({},l))}catch(h){throw console.error(h),new nn(ye(h),0)}if(d.ok||await Jn(d),n!=null&&n.noResolveJson)return d;try{return await d.json()}catch(h){await Jn(h)}}function ce(s){var e;let t=null;Oo(s)&&(t=Object.assign({},s),s.expires_at||(t.expires_at=fo(s.expires_in)));const n=(e=s.user)!==null&&e!==void 0?e:s;return{data:{session:t,user:n},error:null}}function Vn(s){const e=ce(s);return!e.error&&s.weak_password&&typeof s.weak_password=="object"&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.message&&typeof s.weak_password.message=="string"&&s.weak_password.reasons.reduce((t,n)=>t&&typeof n=="string",!0)&&(e.data.weak_password=s.weak_password),e}function ue(s){var e;return{data:{user:(e=s.user)!==null&&e!==void 0?e:s},error:null}}function Ao(s){return{data:s,error:null}}function Lo(s){const{action_link:e,email_otp:t,hashed_token:n,redirect_to:i,verification_type:a}=s,l=Co(s,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),d={action_link:e,email_otp:t,hashed_token:n,redirect_to:i,verification_type:a},h=Object.assign({},l);return{data:{properties:d,user:h},error:null}}function Po(s){return s}function Oo(s){return s.access_token&&s.refresh_token&&s.expires_in}var jo=function(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(s);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(s,n[i])&&(t[n[i]]=s[n[i]]);return t};class Bo{constructor({url:e="",headers:t={},fetch:n}){this.url=e,this.headers=t,this.fetch=ys(n),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await $(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(n){if(C(n))return{data:null,error:n};throw n}}async inviteUserByEmail(e,t={}){try{return await $(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:ue})}catch(n){if(C(n))return{data:{user:null},error:n};throw n}}async generateLink(e){try{const{options:t}=e,n=jo(e,["options"]),i=Object.assign(Object.assign({},n),t);return"newEmail"in n&&(i.new_email=n==null?void 0:n.newEmail,delete i.newEmail),await $(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:Lo,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(C(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await $(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:ue})}catch(t){if(C(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,n,i,a,l,d,h;try{const m={nextPage:null,lastPage:0,total:0},y=await $(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(a=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&a!==void 0?a:""},xform:Po});if(y.error)throw y.error;const b=await y.json(),_=(l=y.headers.get("x-total-count"))!==null&&l!==void 0?l:0,x=(h=(d=y.headers.get("link"))===null||d===void 0?void 0:d.split(","))!==null&&h!==void 0?h:[];return x.length>0&&(x.forEach(T=>{const O=parseInt(T.split(";")[0].split("=")[1].substring(0,1)),L=JSON.parse(T.split(";")[1].split("=")[1]);m[`${L}Page`]=O}),m.total=parseInt(_)),{data:Object.assign(Object.assign({},b),m),error:null}}catch(m){if(C(m))return{data:{users:[]},error:m};throw m}}async getUserById(e){try{return await $(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:ue})}catch(t){if(C(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await $(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:ue})}catch(n){if(C(n))return{data:{user:null},error:n};throw n}}async deleteUser(e,t=!1){try{return await $(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:ue})}catch(n){if(C(n))return{data:{user:null},error:n};throw n}}async _listFactors(e){try{const{data:t,error:n}=await $(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:n}}catch(t){if(C(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await $(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(C(t))return{data:null,error:t};throw t}}}const Uo={getItem:s=>Ge()?globalThis.localStorage.getItem(s):null,setItem:(s,e)=>{Ge()&&globalThis.localStorage.setItem(s,e)},removeItem:s=>{Ge()&&globalThis.localStorage.removeItem(s)}};function Wn(s={}){return{getItem:e=>s[e]||null,setItem:(e,t)=>{s[e]=t},removeItem:e=>{delete s[e]}}}function Do(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const Te={debug:!!(globalThis&&Ge()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class ws extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Fo extends ws{}async function Mo(s,e,t){Te.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",s,e);const n=new globalThis.AbortController;return e>0&&setTimeout(()=>{n.abort(),Te.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",s)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(s,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:n.signal},async i=>{if(i){Te.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",s,i.name);try{return await t()}finally{Te.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",s,i.name)}}else{if(e===0)throw Te.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",s),new Fo(`Acquiring an exclusive Navigator LockManager lock "${s}" immediately failed`);if(Te.debug)try{const a=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(a,null,"  "))}catch(a){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",a)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}Do();const No={url:Xr,storageKey:Qr,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Zr,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function Kn(s,e,t){return await t()}class Xe{constructor(e){var t,n;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Xe.nextInstanceID,Xe.nextInstanceID+=1,this.instanceID>0&&ie()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const i=Object.assign(Object.assign({},No),e);if(this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.persistSession=i.persistSession,this.storageKey=i.storageKey,this.autoRefreshToken=i.autoRefreshToken,this.admin=new Bo({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=ys(i.fetch),this.lock=i.lock||Kn,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,i.lock?this.lock=i.lock:ie()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=Mo:this.lock=Kn,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?i.storage?this.storage=i.storage:Ge()?this.storage=Uo:(this.memoryStorage={},this.storage=Wn(this.memoryStorage)):(this.memoryStorage={},this.storage=Wn(this.memoryStorage)),ie()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(a){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",a)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async a=>{this._debug("received broadcast notification from other tab or client",a),await this._notifyAllSubscribers(a.data.event,a.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${fs}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=po(window.location.href);let n="none";if(this._isImplicitGrantCallback(t)?n="implicit":await this._isPKCECallback(t)&&(n="pkce"),ie()&&this.detectSessionInUrl&&n!=="none"){const{data:i,error:a}=await this._getSessionFromURL(t,n);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),ro(a)){const h=(e=a.details)===null||e===void 0?void 0:e.code;if(h==="identity_already_exists"||h==="identity_not_found"||h==="single_identity_not_deletable")return{error:a}}return await this._removeSession(),{error:a}}const{session:l,redirectType:d}=i;return this._debug("#_initialize()","detected session in URL",l,"redirect type",d),await this._saveSession(l),setTimeout(async()=>{d==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",l):await this._notifyAllSubscribers("SIGNED_IN",l)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return C(t)?{error:t}:{error:new ps("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,n,i;try{const a=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(n=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:ce}),{data:l,error:d}=a;if(d||!l)return{data:{user:null,session:null},error:d};const h=l.session,m=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",h)),{data:{user:m,session:h},error:null}}catch(a){if(C(a))return{data:{user:null,session:null},error:a};throw a}}async signUp(e){var t,n,i;try{let a;if("email"in e){const{email:y,password:b,options:_}=e;let x=null,T=null;this.flowType==="pkce"&&([x,T]=await Re(this.storage,this.storageKey)),a=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:_==null?void 0:_.emailRedirectTo,body:{email:y,password:b,data:(t=_==null?void 0:_.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken},code_challenge:x,code_challenge_method:T},xform:ce})}else if("phone"in e){const{phone:y,password:b,options:_}=e;a=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:y,password:b,data:(n=_==null?void 0:_.data)!==null&&n!==void 0?n:{},channel:(i=_==null?void 0:_.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken}},xform:ce})}else throw new st("You must provide either an email or phone number and a password");const{data:l,error:d}=a;if(d||!l)return{data:{user:null,session:null},error:d};const h=l.session,m=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",h)),{data:{user:m,session:h},error:null}}catch(a){if(C(a))return{data:{user:null,session:null},error:a};throw a}}async signInWithPassword(e){try{let t;if("email"in e){const{email:a,password:l,options:d}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:a,password:l,gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken}},xform:Vn})}else if("phone"in e){const{phone:a,password:l,options:d}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:a,password:l,gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken}},xform:Vn})}else throw new st("You must provide either an email or phone number and a password");const{data:n,error:i}=t;return i?{data:{user:null,session:null},error:i}:!n||!n.session||!n.user?{data:{user:null,session:null},error:new Vt}:(n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),{data:Object.assign({user:n.user,session:n.session},n.weak_password?{weakPassword:n.weak_password}:null),error:i})}catch(t){if(C(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,n,i,a;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(n=e.options)===null||n===void 0?void 0:n.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(a=e.options)===null||a===void 0?void 0:a.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await rt(this.storage,`${this.storageKey}-code-verifier`),[n,i]=(t??"").split("/");try{const{data:a,error:l}=await $(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:n},xform:ce});if(await ot(this.storage,`${this.storageKey}-code-verifier`),l)throw l;return!a||!a.session||!a.user?{data:{user:null,session:null,redirectType:null},error:new Vt}:(a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),{data:Object.assign(Object.assign({},a),{redirectType:i??null}),error:l})}catch(a){if(C(a))return{data:{user:null,session:null,redirectType:null},error:a};throw a}}async signInWithIdToken(e){try{const{options:t,provider:n,token:i,access_token:a,nonce:l}=e,d=await $(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:n,id_token:i,access_token:a,nonce:l,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:ce}),{data:h,error:m}=d;return m?{data:{user:null,session:null},error:m}:!h||!h.session||!h.user?{data:{user:null,session:null},error:new Vt}:(h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("SIGNED_IN",h.session)),{data:h,error:m})}catch(t){if(C(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,n,i,a,l;try{if("email"in e){const{email:d,options:h}=e;let m=null,y=null;this.flowType==="pkce"&&([m,y]=await Re(this.storage,this.storageKey));const{error:b}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:d,data:(t=h==null?void 0:h.data)!==null&&t!==void 0?t:{},create_user:(n=h==null?void 0:h.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},code_challenge:m,code_challenge_method:y},redirectTo:h==null?void 0:h.emailRedirectTo});return{data:{user:null,session:null},error:b}}if("phone"in e){const{phone:d,options:h}=e,{data:m,error:y}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:d,data:(i=h==null?void 0:h.data)!==null&&i!==void 0?i:{},create_user:(a=h==null?void 0:h.shouldCreateUser)!==null&&a!==void 0?a:!0,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},channel:(l=h==null?void 0:h.channel)!==null&&l!==void 0?l:"sms"}});return{data:{user:null,session:null,messageId:m==null?void 0:m.message_id},error:y}}throw new st("You must provide either an email or phone number.")}catch(d){if(C(d))return{data:{user:null,session:null},error:d};throw d}}async verifyOtp(e){var t,n;try{let i,a;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,a=(n=e.options)===null||n===void 0?void 0:n.captchaToken);const{data:l,error:d}=await $(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:a}}),redirectTo:i,xform:ce});if(d)throw d;if(!l)throw new Error("An error occurred on token verification.");const h=l.session,m=l.user;return h!=null&&h.access_token&&(await this._saveSession(h),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",h)),{data:{user:m,session:h},error:null}}catch(i){if(C(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithSSO(e){var t,n,i;try{let a=null,l=null;return this.flowType==="pkce"&&([a,l]=await Re(this.storage,this.storageKey)),await $(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&n!==void 0?n:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:Ao})}catch(a){if(C(a))return{data:null,error:a};throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:n}=e;if(n)throw n;if(!t)throw new le;const{error:i}=await $(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:i}})}catch(e){if(C(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:n,type:i,options:a}=e,{error:l}=await $(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:i,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},redirectTo:a==null?void 0:a.emailRedirectTo});return{data:{user:null,session:null},error:l}}else if("phone"in e){const{phone:n,type:i,options:a}=e,{data:l,error:d}=await $(this.fetch,"POST",t,{headers:this.headers,body:{phone:n,type:i,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}}});return{data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d}}throw new st("You must provide either an email or phone number and a type")}catch(t){if(C(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const n=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await n,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const n=t();for(this.pendingInLock.push((async()=>{try{await n}catch{}})()),await n;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await n}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await rt(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const n=e.expires_at?e.expires_at*1e3-Date.now()<Jt:!1;if(this._debug("#__loadSession()",`session has${n?"":" not"} expired`,"expires_at",e.expires_at),!n){if(this.storage.isServer){let l=this.suppressGetSessionWarning;e=new Proxy(e,{get:(h,m,y)=>(!l&&m==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),l=!0,this.suppressGetSessionWarning=!0),Reflect.get(h,m,y))})}return{data:{session:e},error:null}}const{session:i,error:a}=await this._callRefreshToken(e.refresh_token);return a?{data:{session:null},error:a}:{data:{session:i},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:ue}):await this._useSession(async t=>{var n,i,a;const{data:l,error:d}=t;if(d)throw d;return!(!((n=l.session)===null||n===void 0)&&n.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new le}:await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(a=(i=l.session)===null||i===void 0?void 0:i.access_token)!==null&&a!==void 0?a:void 0,xform:ue})})}catch(t){if(C(t))return io(t)&&(await this._removeSession(),await ot(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async n=>{const{data:i,error:a}=n;if(a)throw a;if(!i.session)throw new le;const l=i.session;let d=null,h=null;this.flowType==="pkce"&&e.email!=null&&([d,h]=await Re(this.storage,this.storageKey));const{data:m,error:y}=await $(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:d,code_challenge_method:h}),jwt:l.access_token,xform:ue});if(y)throw y;return l.user=m.user,await this._saveSession(l),await this._notifyAllSubscribers("USER_UPDATED",l),{data:{user:l.user},error:null}})}catch(n){if(C(n))return{data:{user:null},error:n};throw n}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new le;const t=Date.now()/1e3;let n=t,i=!0,a=null;const{payload:l}=Kt(e.access_token);if(l.exp&&(n=l.exp,i=n<=t),i){const{session:d,error:h}=await this._callRefreshToken(e.refresh_token);if(h)return{data:{user:null,session:null},error:h};if(!d)return{data:{user:null,session:null},error:null};a=d}else{const{data:d,error:h}=await this._getUser(e.access_token);if(h)throw h;a={access_token:e.access_token,refresh_token:e.refresh_token,user:d.user,token_type:"bearer",expires_in:n-t,expires_at:n},await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)}return{data:{user:a.user,session:a},error:null}}catch(t){if(C(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var n;if(!e){const{data:l,error:d}=t;if(d)throw d;e=(n=l.session)!==null&&n!==void 0?n:void 0}if(!(e!=null&&e.refresh_token))throw new le;const{session:i,error:a}=await this._callRefreshToken(e.refresh_token);return a?{data:{user:null,session:null},error:a}:i?{data:{user:i.user,session:i},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(C(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!ie())throw new it("No browser detected.");if(e.error||e.error_description||e.error_code)throw new it(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Mn("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new it("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Mn("No code detected.");const{data:G,error:q}=await this._exchangeCodeForSession(e.code);if(q)throw q;const H=new URL(window.location.href);return H.searchParams.delete("code"),window.history.replaceState(window.history.state,"",H.toString()),{data:{session:G.session,redirectType:null},error:null}}const{provider_token:n,provider_refresh_token:i,access_token:a,refresh_token:l,expires_in:d,expires_at:h,token_type:m}=e;if(!a||!d||!l||!m)throw new it("No session defined in URL");const y=Math.round(Date.now()/1e3),b=parseInt(d);let _=y+b;h&&(_=parseInt(h));const x=_-y;x*1e3<=$e&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${x}s, should have been closer to ${b}s`);const T=_-b;y-T>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",T,_,y):y-T<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",T,_,y);const{data:O,error:L}=await this._getUser(a);if(L)throw L;const M={provider_token:n,provider_refresh_token:i,access_token:a,expires_in:b,expires_at:_,refresh_token:l,token_type:m,user:O.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:M,redirectType:e.type},error:null}}catch(n){if(C(n))return{data:{session:null,redirectType:null},error:n};throw n}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await rt(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var n;const{data:i,error:a}=t;if(a)return{error:a};const l=(n=i.session)===null||n===void 0?void 0:n.access_token;if(l){const{error:d}=await this.admin.signOut(l,e);if(d&&!(so(d)&&(d.status===404||d.status===401||d.status===403)))return{error:d}}return e!=="others"&&(await this._removeSession(),await ot(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=go(),n={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,n),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:n}}}async _emitInitialSession(e){return await this._useSession(async t=>{var n,i;try{const{data:{session:a},error:l}=t;if(l)throw l;await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",a)),this._debug("INITIAL_SESSION","callback id",e,"session",a)}catch(a){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",a),console.error(a)}})}async resetPasswordForEmail(e,t={}){let n=null,i=null;this.flowType==="pkce"&&([n,i]=await Re(this.storage,this.storageKey,!0));try{return await $(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:n,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(a){if(C(a))return{data:null,error:a};throw a}}async getUserIdentities(){var e;try{const{data:t,error:n}=await this.getUser();if(n)throw n;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(C(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:n,error:i}=await this._useSession(async a=>{var l,d,h,m,y;const{data:b,error:_}=a;if(_)throw _;const x=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(l=e.options)===null||l===void 0?void 0:l.redirectTo,scopes:(d=e.options)===null||d===void 0?void 0:d.scopes,queryParams:(h=e.options)===null||h===void 0?void 0:h.queryParams,skipBrowserRedirect:!0});return await $(this.fetch,"GET",x,{headers:this.headers,jwt:(y=(m=b.session)===null||m===void 0?void 0:m.access_token)!==null&&y!==void 0?y:void 0})});if(i)throw i;return ie()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(n==null?void 0:n.url),{data:{provider:e.provider,url:n==null?void 0:n.url},error:null}}catch(n){if(C(n))return{data:{provider:e.provider,url:null},error:n};throw n}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var n,i;const{data:a,error:l}=t;if(l)throw l;return await $(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(n=a.session)===null||n===void 0?void 0:n.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(C(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const n=Date.now();return await vo(async i=>(i>0&&await yo(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await $(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:ce})),(i,a)=>{const l=200*Math.pow(2,i);return a&&Wt(a)&&Date.now()+l-n<$e})}catch(n){if(this._debug(t,"error",n),C(n))return{data:{session:null,user:null},error:n};throw n}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const n=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",n),ie()&&!t.skipBrowserRedirect&&window.location.assign(n),{data:{provider:e,url:n},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const n=await rt(this.storage,this.storageKey);if(this._debug(t,"session from storage",n),!this._isValidSession(n)){this._debug(t,"session is not valid"),n!==null&&await this._removeSession();return}const i=((e=n.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<Jt;if(this._debug(t,`session has${i?"":" not"} expired with margin of ${Jt}s`),i){if(this.autoRefreshToken&&n.refresh_token){const{error:a}=await this._callRefreshToken(n.refresh_token);a&&(console.error(a),Wt(a)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){this._debug(t,"error",n),console.error(n);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,n;if(!e)throw new le;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new gt;const{data:a,error:l}=await this._refreshAccessToken(e);if(l)throw l;if(!a.session)throw new le;await this._saveSession(a.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",a.session);const d={session:a.session,error:null};return this.refreshingDeferred.resolve(d),d}catch(a){if(this._debug(i,"error",a),C(a)){const l={session:null,error:a};return Wt(a)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(l),l}throw(n=this.refreshingDeferred)===null||n===void 0||n.reject(a),a}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,n=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${n}`);try{this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:e,session:t});const a=[],l=Array.from(this.stateChangeEmitters.values()).map(async d=>{try{await d.callback(e,t)}catch(h){a.push(h)}});if(await Promise.all(l),a.length>0){for(let d=0;d<a.length;d+=1)console.error(a[d]);throw a[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await vs(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await ot(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ie()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),$e);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:n}}=t;if(!n||!n.refresh_token||!n.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((n.expires_at*1e3-e)/$e);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${$e}ms, refresh threshold is ${en} ticks`),i<=en&&await this._callRefreshToken(n.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof ws)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ie()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,n){const i=[`provider=${encodeURIComponent(t)}`];if(n!=null&&n.redirectTo&&i.push(`redirect_to=${encodeURIComponent(n.redirectTo)}`),n!=null&&n.scopes&&i.push(`scopes=${encodeURIComponent(n.scopes)}`),this.flowType==="pkce"){const[a,l]=await Re(this.storage,this.storageKey),d=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(l)}`});i.push(d.toString())}if(n!=null&&n.queryParams){const a=new URLSearchParams(n.queryParams);i.push(a.toString())}return n!=null&&n.skipBrowserRedirect&&i.push(`skip_http_redirect=${n.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var n;const{data:i,error:a}=t;return a?{data:null,error:a}:await $(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(n=i==null?void 0:i.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(C(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var n,i;const{data:a,error:l}=t;if(l)return{data:null,error:l};const d=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:h,error:m}=await $(this.fetch,"POST",`${this.url}/factors`,{body:d,headers:this.headers,jwt:(n=a==null?void 0:a.session)===null||n===void 0?void 0:n.access_token});return m?{data:null,error:m}:(e.factorType==="totp"&&(!((i=h==null?void 0:h.totp)===null||i===void 0)&&i.qr_code)&&(h.totp.qr_code=`data:image/svg+xml;utf-8,${h.totp.qr_code}`),{data:h,error:null})})}catch(t){if(C(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:i,error:a}=t;if(a)return{data:null,error:a};const{data:l,error:d}=await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(n=i==null?void 0:i.session)===null||n===void 0?void 0:n.access_token});return d?{data:null,error:d}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+l.expires_in},l)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",l),{data:l,error:d})})}catch(t){if(C(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:i,error:a}=t;return a?{data:null,error:a}:await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(n=i==null?void 0:i.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(C(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:n}=await this._challenge({factorId:e.factorId});return n?{data:null,error:n}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const n=(e==null?void 0:e.factors)||[],i=n.filter(l=>l.factor_type==="totp"&&l.status==="verified"),a=n.filter(l=>l.factor_type==="phone"&&l.status==="verified");return{data:{all:n,totp:i,phone:a},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,n;const{data:{session:i},error:a}=e;if(a)return{data:null,error:a};if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:l}=Kt(i.access_token);let d=null;l.aal&&(d=l.aal);let h=d;((n=(t=i.user.factors)===null||t===void 0?void 0:t.filter(b=>b.status==="verified"))!==null&&n!==void 0?n:[]).length>0&&(h="aal2");const y=l.amr||[];return{data:{currentLevel:d,nextLevel:h,currentAuthenticationMethods:y},error:null}}))}async fetchJwk(e,t={keys:[]}){let n=t.keys.find(l=>l.kid===e);if(n||(n=this.jwks.keys.find(l=>l.kid===e),n&&this.jwks_cached_at+to>Date.now()))return n;const{data:i,error:a}=await $(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(a)throw a;if(!i.keys||i.keys.length===0)throw new Ke("JWKS is empty");if(this.jwks=i,this.jwks_cached_at=Date.now(),n=i.keys.find(l=>l.kid===e),!n)throw new Ke("No matching signing key found in JWKS");return n}async getClaims(e,t={keys:[]}){try{let n=e;if(!n){const{data:x,error:T}=await this.getSession();if(T||!x.session)return{data:null,error:T};n=x.session.access_token}const{header:i,payload:a,signature:l,raw:{header:d,payload:h}}=Kt(n);if(So(a.exp),!i.kid||i.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:x}=await this.getUser(n);if(x)throw x;return{data:{claims:a,header:i,signature:l},error:null}}const m=xo(i.alg),y=await this.fetchJwk(i.kid,t),b=await crypto.subtle.importKey("jwk",y,m,!0,["verify"]);if(!await crypto.subtle.verify(m,b,l,ho(`${d}.${h}`)))throw new Ke("Invalid JWT signature");return{data:{claims:a,header:i,signature:l},error:null}}catch(n){if(C(n))return{data:null,error:n};throw n}}}Xe.nextInstanceID=0;const qo=Xe;class Ho extends qo{constructor(e){super(e)}}var zo=function(s,e,t,n){function i(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(y){try{m(n.next(y))}catch(b){l(b)}}function h(y){try{m(n.throw(y))}catch(b){l(b)}}function m(y){y.done?a(y.value):i(y.value).then(d,h)}m((n=n.apply(s,e||[])).next())})};class Jo{constructor(e,t,n){var i,a,l;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const d=Gr(e),h=new URL(d);this.realtimeUrl=new URL("realtime/v1",h),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",h),this.storageUrl=new URL("storage/v1",h),this.functionsUrl=new URL("functions/v1",h);const m=`sb-${h.hostname.split(".")[0]}-auth-token`,y={db:Nr,realtime:Hr,auth:Object.assign(Object.assign({},qr),{storageKey:m}),global:Mr},b=Yr(n??{},y);this.storageKey=(i=b.auth.storageKey)!==null&&i!==void 0?i:"",this.headers=(a=b.global.headers)!==null&&a!==void 0?a:{},b.accessToken?(this.accessToken=b.accessToken,this.auth=new Proxy({},{get:(_,x)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(x)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((l=b.auth)!==null&&l!==void 0?l:{},this.headers,b.global.fetch),this.fetch=Wr(t,this._getAccessToken.bind(this),b.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},b.realtime)),this.rest=new lr(new URL("rest/v1",h).href,{headers:this.headers,schema:b.db.schema,fetch:this.fetch}),b.accessToken||this._listenForAuthEvents()}get functions(){return new Ui(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}get storage(){return new Ur(this.storageUrl.href,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},n={}){return this.rest.rpc(e,t,n)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return zo(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:n}=yield this.auth.getSession();return(t=(e=n.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:i,storageKey:a,flowType:l,lock:d,debug:h},m,y){const b={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Ho({url:this.authUrl.href,headers:Object.assign(Object.assign({},b),m),storageKey:a,autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:i,flowType:l,lock:d,debug:h,fetch:y,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new kr(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,n)=>{this._handleTokenChanged(t,"CLIENT",n==null?void 0:n.access_token)})}_handleTokenChanged(e,t,n){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==n?this.changedAccessToken=n:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const Gn=(s,e,t)=>new Jo(s,e,t),re="https://nklwzunoipplfkysaztl.supabase.co",Ye="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rbHd6dW5vaXBwbGZreXNhenRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDIxMjAsImV4cCI6MjA3NzA3ODEyMH0.OYSO3RLcZjUjmSn9hH3bW2TerTsHK2mXeOWWUUQmA3g";console.log("[Supabase Init] rawUrl:",JSON.stringify(re),"type:","string","length:",re==null?void 0:re.length);console.log("[Supabase Init] rawKey exists:",!0,"type:","string","length:",Ye==null?void 0:Ye.length);const Vo=s=>{const e=s.trim();return e&&e!=="undefined"&&e.startsWith("https://")},Wo=s=>s.length>50,Ko="https://",Go="nklwzunoipplfkysaztl",Yo=".supabase.co",cn=Ko+Go+Yo;let A,B;Vo(re)?(A=re.trim(),console.log("[Supabase Init] Using env VITE_SUPABASE_URL:",A.substring(0,30)+"...")):(A=cn,console.warn("[Supabase Init] rawUrl invalid, using hardcoded fallback. rawUrl was:",JSON.stringify(re),"type:","string","length:",re==null?void 0:re.length),console.log("[Supabase Init] Fallback URL set to:",A));const Xo="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.",Qo="eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rbHd6dW5vaXBwbGZreXNhenRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDIxMjAsImV4cCI6MjA3NzA3ODEyMH0.",Zo="OYSO3RLcZjUjmSn9hH3bW2TerTsHK2mXeOWWUUQmA3g",dn=Xo+Qo+Zo;Wo(Ye)?(B=Ye,console.log("[Supabase Init] Using env VITE_SUPABASE_ANON_KEY")):(B=dn,console.warn("[Supabase Init] rawKey invalid, using hardcoded fallback"));(!A||typeof A!="string"||!A.startsWith("https://"))&&(console.error("[Supabase Init] CRITICAL: supabaseUrl still invalid! Forcing hardcoded URL"),console.error("[Supabase Init] Invalid supabaseUrl value:",JSON.stringify(A),"type:",typeof A,"length:",A==null?void 0:A.length),A=cn,console.log("[Supabase Init] After forcing fallback, supabaseUrl:",A));(!B||typeof B!="string"||B.length<50)&&(console.error("[Supabase Init] CRITICAL: supabaseAnonKey still invalid! Forcing hardcoded key"),B=dn);console.log("[Supabase Init] Final supabaseUrl:",JSON.stringify(A),"type:",typeof A,"length:",A==null?void 0:A.length);console.log("[Supabase Init] Final supabaseAnonKey exists:",!!B,"length:",B==null?void 0:B.length);let R=null;try{if(!A||typeof A!="string"||!A.startsWith("https://"))throw new Error("supabaseUrl is invalid: "+A);if(!B||typeof B!="string"||B.length<50)throw new Error("supabaseAnonKey is invalid");const s=A.substring(0,30)+"...";console.log("[Supabase Init] Creating client with URL:",s),R=Gn(A,B,{auth:{detectSessionInUrl:!1}}),console.log("[Supabase Init] Client created successfully")}catch(s){console.error("[Supabase Init] Failed to create Supabase client:",s),console.error("[Supabase Init] URL was:",JSON.stringify(A),"type:",typeof A,"length:",A==null?void 0:A.length),console.error("[Supabase Init] Key exists:",!!B,"type:",typeof B,"length:",B==null?void 0:B.length);try{console.error("[Supabase Init] Attempting last resort with hardcoded values");const e=cn,t=dn;console.error("[Supabase Init] Last resort URL:",e,"length:",e.length),console.error("[Supabase Init] Last resort Key length:",t.length),R=Gn(e,t,{auth:{detectSessionInUrl:!1}}),console.log("[Supabase Init] Last resort client created successfully"),A=e,B=t}catch(e){console.error("[Supabase Init] Last resort also failed:",e),console.error("[Supabase Init] Last resort error details:",e.message,e.stack)}}const ea={};(()=>{let s=[],e=-1,t=0,n=2,i=null,a,l=[],d=null,h=null,m=null,y=null,b=[],_=[],x=null,T=!1,O=!1;function L(r){return(typeof import.meta<"u"&&ea?"/".replace(/\/$/,""):"")+"/"+(r.startsWith("/")?r.slice(1):r)}function M(r){return console.log(" [recipeToRow] Converting recipe to DB row:",r.name),console.log("  - imagePath (JS)  image_path (DB):",r.imagePath||"null"),{name:r.name,source:r.source||null,ingredients:r.ingredients||"",instructions:r.instructions||"",category:r.category||"",notes:r.notes||null,rating:r.rating??0,difficulty:r.difficulty??null,image:r.image||null,image_path:r.imagePath||null,recipe_link:r.recipeLink||null,video_url:r.videoUrl||null,preparation_time:r.preparationTime||null}}function G(r){return console.log(" [rowToRecipe] Converting DB row to recipe:",r.name),console.log("  - image_path (DB)  imagePath (JS):",r.image_path||"null"),{id:r.id,name:r.name,source:r.source,ingredients:r.ingredients,instructions:r.instructions,category:r.category,notes:r.notes,rating:r.rating,difficulty:r.difficulty??null,image:r.image,imagePath:r.image_path,recipeLink:r.recipe_link,videoUrl:r.video_url,preparationTime:r.preparation_time}}const q="recipes_cache",H="recipes_cache_meta",J="recipes_cache_version",un="1.0.1",bs={" ":"restaurant",:"bakery_dining",:"soup_kitchen"," ":"dinner_dining",:"lunch_dining",:"eco",:"restaurant_menu",:"cake",:"icecream",:"cookie"},hn={" ":"teal",:"amber",:"blue"," ":"red",:"purple",:"emerald",:"blue",:"amber",:"rose",:"orange"};(function(){localStorage.getItem(J)!==un&&(console.log("Cache version changed, clearing old cache..."),localStorage.removeItem(q),localStorage.removeItem(H),localStorage.setItem(J,un))})();function _s(){try{const r=localStorage.getItem(q);if(r)return JSON.parse(r)}catch(r){console.warn("Failed to load from cache:",r)}return null}function Be(r){try{const o=r.map(c=>({...c,image:null,imagePath:c.imagePath||c.image_path}));localStorage.setItem(q,JSON.stringify(o)),localStorage.setItem(H,JSON.stringify({timestamp:Date.now(),count:r.length}))}catch(o){console.warn("Failed to save to cache:",o);try{localStorage.removeItem(q),localStorage.removeItem(H)}catch{}}}async function Es(r){if(!R)throw new Error("Supabase  .   Supabase .");const{error:o}=await R.from("recipes").delete().eq("id",r);if(o)throw o;Be(s)}async function ae(r){if(!R)throw new Error("Supabase  .   Supabase .");console.log(" [saveRecipeToDB] Saving recipe to DB:",r.name),console.log("  - Recipe ID:",r.id||"new recipe"),console.log("  - imagePath before save:",r.imagePath);const o=M(r);if(console.log("  - image_path in DB row:",o.image_path),r.id){const{error:c}=await R.from("recipes").update(o).eq("id",r.id);if(c)throw console.error(" [saveRecipeToDB] Update failed:",c),c;console.log("   Recipe updated in DB")}else{const{data:c,error:f}=await R.from("recipes").insert(o).select("id").single();if(f)throw console.error(" [saveRecipeToDB] Insert failed:",f),f;r.id=c.id,console.log("   New recipe inserted with ID:",r.id)}try{const{data:c,error:f}=await R.from("recipes").select("id,image_path").eq("id",r.id).single();f?console.warn(" [saveRecipeToDB] Could not verify save:",f):(console.log("   Verification - image_path in DB:",c.image_path),c.image_path&&!r.imagePath?(r.imagePath=c.image_path,console.log("   Updated recipe.imagePath from DB verification")):!c.image_path&&r.imagePath?console.warn("   WARNING: image_path not saved to DB! Expected:",r.imagePath):c.image_path===r.imagePath&&console.log("   image_path verified correctly saved"))}catch(c){console.warn(" [saveRecipeToDB] Verification failed:",c)}Be(s),console.log("   Cache updated")}async function fn(r){if(!R)throw new Error("Supabase  .   Supabase .");const o=r.map(p=>p.id).filter(Boolean),{data:c}=await R.from("recipes").select("id"),f=(c||[]).filter(p=>!o.includes(p.id)).map(p=>p.id);if(f.length>0){const{error:p}=await R.from("recipes").delete().in("id",f);if(p)throw p}const u=r.filter(p=>p.id),g=r.filter(p=>!p.id);for(const p of u){const w=M(p);await R.from("recipes").update(w).eq("id",p.id)}if(g.length>0){const p=g.map(M),{data:w,error:v}=await R.from("recipes").insert(p).select("id");if(v)throw v;w.forEach((S,k)=>{g[k].id=S.id})}Be(r)}async function ks(r){if(!R)throw new Error("Supabase  .   Supabase .");try{const{data:o,error:c}=await R.from("recipes").select("*").eq("id",r).single();if(c)throw c;return o?G(o):null}catch(o){return console.warn("Failed to load single recipe:",o),null}}async function pt(){if(!R)throw new Error("Supabase  .   Supabase .");console.log(" [loadRecipesFromDB] Loading recipes from database..."),T=!1;const{data:r,error:o}=await R.from("recipes").select("id,name,source,ingredients,instructions,category,notes,rating,difficulty,recipe_link,video_url,preparation_time,image_path,image,created_at").order("created_at",{ascending:!0});if(o)throw console.error(" [loadRecipesFromDB] Failed to load:",o),o;console.log(`   Loaded ${(r==null?void 0:r.length)||0} recipes from DB`);const c=(r==null?void 0:r.filter(u=>u.image_path).length)||0;console.log(`   Recipes with image_path: ${c}/${(r==null?void 0:r.length)||0}`);const f=(r||[]).map(G);return Be(f),f}async function Is(r,o){if(!R||!r||r.length===0)return;const{data:c,error:f}=await R.from("recipes").select("id,image_path").in("id",r);if(f)throw f;(c||[]).forEach(u=>{u&&u.id&&o.set(u.id,u.image_path||null)})}async function Ss(r,o){for(const c of r)try{const{data:f,error:u}=await R.from("recipes").select("id,image_path").eq("id",c).single();!u&&f&&f.id?o.set(f.id,f.image_path||null):u&&console.warn("Failed to load image for recipe id:",c,u)}catch(f){console.warn("Failed to load image for recipe id:",c,f)}}async function gn(){if(!R||!Array.isArray(s)||s.length===0)return;const r=s.map(u=>u&&u.id).filter(Boolean);if(r.length===0)return;const o=new Map,c=50;for(let u=0;u<r.length;u+=c){const g=r.slice(u,u+c);try{await Is(g,o)}catch(p){console.warn("Chunk image load failed, retrying individually:",p),await Ss(g,o)}}let f=!1;s=s.map(u=>!u||!u.id?u:o.has(u.id)?(f=!0,{...u,imagePath:o.get(u.id)}):u),f&&F(s)}async function mt(){if(!R){const c=localStorage.getItem("timerVolume"),f=c!=null?parseFloat(c):80;return{lastBackup:null,recipesPerRow:4,timerVisible:!1,timerVolume:Number.isFinite(f)?Math.min(100,Math.max(0,f)):80}}const{data:r}=await R.from("recipe_book_settings").select("key, value"),o=(r||[]).reduce((c,f)=>(c[f.key]=f.value,c),{});if(o.lastBackup==null){const c=localStorage.getItem("lastBackup");if(c){const f=parseInt(c,10);isNaN(f)||(o.lastBackup=f,await fe("lastBackup",f),localStorage.removeItem("lastBackup"))}}return{lastBackup:o.lastBackup??null,recipesPerRow:o.recipesPerRow||4,timerVisible:o.timerVisible===!0,timerVolume:Math.min(100,Math.max(0,parseFloat(o.timerVolume))||80)}}async function fe(r,o){R&&await R.from("recipe_book_settings").upsert({key:r,value:o,updated_at:new Date().toISOString()},{onConflict:"key"})}function yt(r){const o=document.getElementById("timer-widget");o&&(r?o.classList.add("is-open"):o.classList.remove("is-open"))}function pn(){const r=typeof location<"u"&&location.pathname?location.pathname:"";return!r||!r.startsWith("/recipe/")?null:r.slice(8).split("/")[0].trim()||null}function xs(){const r=pn();if(!r)return;const o=s.findIndex(function(c){return c&&c.id===r});o>=0&&ge(o)}document.addEventListener("DOMContentLoaded",async()=>{try{await Cs()}catch(r){console.error(" :",r),alert("  .    .")}});async function Cs(){try{const o=pn();if(o){console.log("Loading shared recipe:",o),O=!0;const g=await mt();document.getElementById("filterRating").innerHTML=St(),De(g.recipesPerRow||4),Ct(),yt(g.timerVisible),Ft(g),Rt();const p=document.getElementById("recipesContainer");p&&(p.style.display="none");const w=document.getElementById("searchContainer");w&&(w.style.display="none");const v=document.querySelector(".category-filter-row");v&&(v.style.display="none");const S=document.querySelector(".floating-actions");S&&(S.style.display="none");const k=document.querySelector(".grid-selector-wrapper");k&&(k.style.display="none");const I=await ks(o);I?(s=[I],await Mt(),mn()):(alert("  "),window.location.href="/");return}const c=_s(),f=await mt();c&&c.length>0&&(s=c,F(s),se(),Y(),console.log("Loaded",s.length,"recipes from cache")),document.getElementById("filterRating").innerHTML=St(),xt(f.lastBackup),De(f.recipesPerRow||4),Ct(),yt(f.timerVisible),Ft(f),Rt();const u=async()=>{try{const g=await pt();if(!Array.isArray(g))return;const p=new Set((g||[]).map(v=>v&&v.id).filter(Boolean)),w=(s||[]).filter(v=>v&&v.id&&!p.has(v.id));s=[...g||[],...w],console.log("[loadFromServer] Merged: "+(g||[]).length+" from server, "+w.length+" local-only preserved. Total: "+s.length),await Mt(),F(s),se(),Y(),T&&(await gn(),F(s))}catch(g){if(console.error("Failed to load from server:",g),c&&c.length>0)try{await gn(),F(s)}catch(p){console.warn("Failed to load images:",p)}}};c&&c.length>0?u():await u(),window.popstateHandlerAdded||(window.addEventListener("popstate",function(){var g=document.getElementById("popup");g&&g.style.display==="flex"&&Ee()}),window.popstateHandlerAdded=!0)}catch(o){console.error("  :",o),s=[],F([]),se(),Y();var r=document.getElementById("filterRating");r&&(r.innerHTML=St()),xt(null),De(4),Ct(),yt(!1),Ft({timerVolume:80}),Rt(),xs(),window.popstateHandlerAdded||(window.addEventListener("popstate",function(){var c=document.getElementById("popup");c&&c.style.display==="flex"&&Ee()}),window.popstateHandlerAdded=!0)}}const be={:["/default-images/breads/1.jpg","/default-images/breads/2.jpg","/default-images/breads/3.jpg"],:["/default-images/soups/1.jpg","/default-images/soups/2.jpg","/default-images/soups/3.jpg"]," ":["/default-images/main-dishes/1.jpg","/default-images/main-dishes/2.jpg","/default-images/main-dishes/3.jpg"],:["/default-images/sides/1.jpg","/default-images/sides/2.jpg","/default-images/sides/3.jpg"],:["/default-images/salads/1.jpg","/default-images/salads/2.jpg","/default-images/salads/3.jpg"],:["/default-images/other/1.jpg","/default-images/other/2.jpg","/default-images/other/3.jpg"],:["/default-images/cakes/1.jpg","/default-images/cakes/2.jpg","/default-images/cakes/3.jpg"],:["/default-images/desserts/1.jpg","/default-images/desserts/2.jpg","/default-images/desserts/3.jpg"]};function _e(r){if(r&&be[r]){const c=be[r],f=Math.floor(Math.random()*c.length);return c[f]}const o=["/default-images/other/1.jpg","/default-images/other/2.jpg","/default-images/other/3.jpg"];return o[Math.floor(Math.random()*o.length)]}function et(r,o){if(!r||r.trim()==="")return _e(o);if(r.startsWith("http://")||r.startsWith("https://")||r.startsWith("data:")||r.startsWith("/"))return r;if(r.startsWith("assets/default-images/"))return"/"+r.replace("assets/","");if(r.startsWith("default-images/"))return"/"+r;const c=r;if(o&&be[o]){const u=be[o].find(g=>g.endsWith("/"+c)||g.endsWith(c));if(u)return u}for(const f in be){const g=be[f].find(p=>p.endsWith("/"+c)||p.endsWith(c));if(g)return g}return _e(o)}function tt(r){if(!r)return"";var o=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/,c=r.match(o);return c&&c[7].length===11?"https://www.youtube.com/embed/"+c[7]:""}function F(r){const o=document.getElementById("recipesContainer");if(o.innerHTML="",console.log("Displaying recipes:",r),!Array.isArray(r)){console.error("Invalid recipes array:",r);return}r.forEach((c,f)=>{if(!c||!c.name){console.error("Invalid recipe at index",f,c);return}const u=s.indexOf(c);console.log("Recipe:",c.name,"filtered index:",f,"actual index:",u);const g=document.createElement("div");g.className="recipe-card",g.onclick=()=>ge(u);const p=document.createElement("img");p.className="recipe-card-image",p.loading="lazy";const w=c.imagePath||c.image;if(console.log(` [displayRecipes] Recipe "${c.name}":`),console.log("  - imagePath:",c.imagePath||"none"),console.log("  - image (base64):",c.image?"exists":"none"),console.log("  - imageSource chosen:",w||"none - will use default"),w){const E=xe(w,{});console.log("  - getImageUrl returned:",E||"null"),E?(p.src=E,console.log("   Image URL set successfully")):(console.log("   getImageUrl returned null, using default image"),p.src=et(null,c.category),g.classList.add("using-default-image"))}else console.log("   No imageSource, using default image"),p.src=et(null,c.category),g.classList.add("using-default-image");p.alt=c.name,g.classList.add("image-loading"),p.onload=function(){console.log(`   [displayRecipes] Image loaded successfully for "${c.name}"`),g.classList.remove("image-loading"),g.classList.add("image-loaded")};let v=0;p.onerror=function(){if(v++,console.log(`   [displayRecipes] Image load error for "${c.name}" (attempt ${v})`),console.log("    - Failed URL:",this.src),v===1){const E=_e(c.category);console.log("    - Trying fallback image:",E),this.src!==E?(this.src=E,this.removeAttribute("srcset"),g.classList.add("using-default-image")):(console.log("    - Fallback also failed, hiding image"),this.style.display="none",this.onerror=null)}else console.log("    - Max retries reached, hiding image"),this.style.display="none",this.onerror=null;g.classList.remove("image-loading")},p.addEventListener("load",function(){this.classList.add("loaded")}),g.appendChild(p);const S=document.createElement("div");S.className="recipe-info-overlay";const k=document.createElement("h3");if(k.className="recipe-name",k.textContent=c.name,S.appendChild(k),c.source){const E=document.createElement("p");E.className="recipe-source",E.textContent=c.source,S.appendChild(E)}g.appendChild(S);const I=document.createElement("div");I.className="action-buttons-overlay",I.innerHTML=`
           <button class="action-btn" onclick="event.stopPropagation(); editRecipe(${u})" data-tooltip="">
             <i class="fas fa-edit"></i>
           </button>
           <button class="action-btn" onclick="event.stopPropagation(); copyRecipeLink(${u})" data-tooltip=" ">
             <i class="fas fa-link"></i>
           </button>
           <button class="action-btn" onclick="event.stopPropagation(); shareRecipe(${u})" data-tooltip="">
             <i class="fas fa-share"></i>
           </button>
           <button class="action-btn" onclick="event.stopPropagation(); downloadRecipe(${u})" data-tooltip="">
             <i class="fas fa-download"></i>
           </button>
           <button class="action-btn" onclick="event.stopPropagation(); confirmDeleteRecipe(${u})" data-tooltip="">
             <i class="fas fa-trash"></i>
           </button>
        `,g.appendChild(I),o.appendChild(g),console.log("Added recipe card:",c.name)})}function ge(r){const o=s[r],c=document.getElementById("popup"),f=document.getElementById("popupBody");c.classList.add("visible"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open");const u=o.rating||0;let g="";for(let I=1;I<=5;I++){const E=I<=u?"text-yellow-500 fill-current":"text-gray-300";g+=`<span class="material-symbols-outlined text-[16px] ${E}" onclick="rateRecipe(${r}, ${I})">star</span>`}const p=o.difficulty>=1&&o.difficulty<=3?o.difficulty:2,w=yn[p]||"";let v="";for(let I=1;I<=3;I++){const E=I<=p?"text-orange-400 fill-current":"text-gray-300";v+=`<span class="material-symbols-outlined text-[14px] ${E}">star</span>`}const S=o.ingredients.split(`
`).map((I,E)=>I.trim()?`
          <label class="custom-checkbox-item">
            <input class="hidden peer" type="checkbox"/>
            <div class="checkbox-box">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="4"></path></svg>
            </div>
            <span class="ingredient-text">${I}</span>
          </label>
        `:"").join(""),k=o.instructions.split(`
`).map((I,E)=>I.trim()?`
          <div class="step-item">
            <span class="step-number">${E+1}</span>
            <p class="step-text">${I}</p>
          </div>
        `:"").join("");f.innerHTML=`
        <button class="close-popup-floating" onclick="closePopup()">
            <span class="material-symbols-outlined">close</span>
        </button>
        <div class="recipe-full">
          <!-- Image Section (Left) -->
          <div class="recipe-image-section">
            <div class="recipe-actions-row recipe-actions-above-image">
              <button class="recipe-action-btn" onclick="editRecipe(${r})" title="">
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button class="recipe-action-btn" onclick="confirmDeleteRecipe(${r})" title="">
                <span class="material-symbols-outlined">delete</span>
              </button>
              <button class="recipe-action-btn" onclick="copyRecipeLink(${r})" title=" ">
                <span class="material-symbols-outlined">link</span>
              </button>
              <button class="recipe-action-btn" onclick="shareRecipe(${r})" title="">
                <span class="material-symbols-outlined">share</span>
              </button>
              <button class="recipe-action-btn" onclick="downloadRecipe(${r})" title="">
                <span class="material-symbols-outlined">download</span>
              </button>
            </div>
            <img 
              loading="lazy"
              class="recipe-popup-image"
              src="${xe(o.imagePath||o.image,{})||et(null,o.category)}" 
              srcset="${Tn(o.imagePath||o.image)}"
              sizes="(max-width: 768px) 100vw, 800px"
              alt="${o.name}" 
              onerror="this.src=getRandomDefaultImageForCategory('${o.category}'); this.removeAttribute('srcset');"
              onload="this.classList.add('loaded')">
            <div class="recipe-image-overlay"></div>
            <div class="recipe-image-content">
              <span class="recipe-category-badge">${o.category}</span>
            </div>
          </div>

          <!-- Content Section (Right) -->
          <div class="recipe-content-section">
            <!-- Sticky Header -->
            <div class="recipe-content-header">
              <div class="recipe-header-info">
                <h1 class="recipe-main-title">${o.name}</h1>
                <p class="recipe-source-link">: <a href="${o.recipeLink||"#"}" target="_blank">${o.source||" "}</a></p>
              </div>
            </div>

            <!-- Scrollable Content -->
            <div class="recipe-scroll-content">
              <!-- Meta Grid -->
              <div class="recipe-meta-grid">
                <div class="meta-item">
                  <span class="material-symbols-outlined meta-icon">schedule</span>
                  <span class="meta-label"> </span>
                  <span class="meta-value">${o.preparationTime||"--"} </span>
                </div>
                <div class="meta-item">
                  <span class="material-symbols-outlined meta-icon" style="color: #fb923c;">star</span>
                  <span class="meta-label"> </span>
                  <div class="flex items-center gap-0.5" title="${w}">
                    ${v}
                  </div>
                  <span class="meta-value meta-value-difficulty">${w}</span>
                </div>
                <div class="meta-item">
                  <span class="material-symbols-outlined meta-icon" style="color: #60a5fa;">category</span>
                  <span class="meta-label"></span>
                  <span class="meta-value">${o.category}</span>
                </div>
                <div class="meta-item">
                  <div class="flex mb-1">
                    ${g}
                  </div>
                  <span class="meta-label"></span>
                  <span class="meta-value">${u.toFixed(1)}</span>
                </div>
              </div>

              <!-- Main Grid Layout -->
              <div class="recipe-grid-layout">
                <!-- Ingredients -->
                <section>
                  <h3 class="section-title">
                    <span class="material-symbols-outlined">shopping_basket</span>
                    
                  </h3>
                  <div class="ingredients-list-styled">
                    ${S}
                  </div>
                </section>

                <!-- Steps -->
                <section>
                  <h3 class="section-title">
                    <span class="material-symbols-outlined">cooking</span>
                     
                  </h3>
                  <div class="steps-list-styled">
                    ${k}
                  </div>
                </section>
              </div>

              <!-- Video Section -->
              ${o.videoUrl?`
              <section class="video-section">
                <h3 class="section-title">
                  <span class="material-symbols-outlined" style="color: #ef4444;">play_circle</span>
                   
                </h3>
                <div class="video-container-styled">
                  <iframe src="${tt(o.videoUrl)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
              </section>
              `:""}

              <!-- Notes Section -->
              ${o.notes?`
              <section class="notes-section">
                <h3 class="notes-title">
                  <span class="material-symbols-outlined">description</span>
                    (Notes)
                </h3>
                <div class="notes-text">
                  ${o.notes.replace(/\n/g,"<br>")}
                </div>
              </section>
              `:""}

              <!-- External Link -->
              ${o.recipeLink?`
              <section class="original-link-section">
                <div class="link-box">
                  <span class="material-symbols-outlined text-gray-400">link</span>
                  <span class="text-sm font-medium text-gray-600 dark:text-gray-300">   :</span>
                  <a href="${o.recipeLink}" target="_blank" class="text-sm font-bold text-primary hover:underline" style="color: var(--primary-color);"> </a>
                </div>
              </section>
              `:""}
              
              <div class="h-12"></div>
            </div>

          </div>
        </div>
      `,c.style.display="flex",o&&o.id&&typeof history<"u"&&history.pushState&&history.pushState({},"","/recipe/"+o.id)}function Ee(){const r=document.getElementById("popup");if(O){r.classList.remove("visible"),r.style.display="none",document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),mn();return}typeof location<"u"&&location.pathname&&location.pathname.startsWith("/recipe/")&&typeof history<"u"&&history.replaceState&&history.replaceState({},"","/"),r.classList.remove("visible"),r.style.display="none",document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open")}function mn(){if(!s||s.length===0)return;const r=s[0],o=document.getElementById("recipesContainer");if(!o)return;o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.minHeight="80vh",o.style.padding="2rem";const c=r.ingredients.split(`
`).map(u=>u.trim()?`<li class="text-gray-700 dark:text-gray-300">${u}</li>`:"").join(""),f=r.instructions.split(`
`).map((u,g)=>u.trim()?`<li class="text-gray-700 dark:text-gray-300 mb-3"><strong>${g+1}.</strong> ${u}</li>`:"").join("");o.innerHTML=`
        <div class="max-w-4xl w-full bg-white dark:bg-card-dark rounded-2xl shadow-2xl overflow-hidden">
          <!-- Header -->
          <div class="bg-gradient-to-r from-primary to-accent p-8 text-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-20">
              <div class="absolute top-0 left-0 w-32 h-32 bg-white rounded-full -translate-x-1/2 -translate-y-1/2"></div>
              <div class="absolute bottom-0 right-0 w-48 h-48 bg-white rounded-full translate-x-1/3 translate-y-1/3"></div>
            </div>
            <div class="relative z-10">
              <span class="material-symbols-outlined text-6xl mb-4 text-slate-800">restaurant_menu</span>
              <h1 class="text-4xl font-bold text-slate-800 mb-2">${r.name}</h1>
              <p class="text-lg text-slate-700">: ${r.source||" "}</p>
              <div class="mt-4 inline-block bg-white/30 backdrop-blur-sm px-6 py-2 rounded-full">
                <span class="text-sm font-semibold text-slate-800">  </span>
              </div>
            </div>
          </div>
          
          <!-- Image Section -->
          ${r.image?`
          <div class="w-full h-80 overflow-hidden">
            <img src="${et(r.image,r.category)}" 
                 alt="${r.name}" 
                 onerror="this.src=getRandomDefaultImageForCategory('${r.category}')"
                 class="w-full h-full object-cover">
          </div>
          `:""}
          
          <!-- Content -->
          <div class="p-8">
            <!-- Meta Info -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
              <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                <span class="material-symbols-outlined text-primary text-3xl">schedule</span>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2"> </p>
                <p class="font-bold text-gray-800 dark:text-gray-200">${r.preparationTime||"--"} </p>
              </div>
              <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                <span class="material-symbols-outlined text-accent text-3xl">category</span>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2"></p>
                <p class="font-bold text-gray-800 dark:text-gray-200">${r.category}</p>
              </div>
              <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl col-span-2 md:col-span-1">
                <span class="material-symbols-outlined text-yellow-500 text-3xl">star</span>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2"></p>
                <p class="font-bold text-gray-800 dark:text-gray-200">${(r.rating||0).toFixed(1)} </p>
              </div>
            </div>
            
            <!-- Ingredients -->
            <div class="mb-8">
              <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-gray-200">
                <span class="material-symbols-outlined ml-2 text-green-600">shopping_basket</span>
                
              </h2>
              <ul class="list-disc list-inside space-y-2 bg-green-50 dark:bg-green-900/20 p-6 rounded-xl">
                ${c}
              </ul>
            </div>
            
            <!-- Instructions -->
            <div class="mb-8">
              <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-gray-200">
                <span class="material-symbols-outlined ml-2 text-orange-500">cooking</span>
                 
              </h2>
              <ol class="space-y-3 bg-orange-50 dark:bg-orange-900/20 p-6 rounded-xl">
                ${f}
              </ol>
            </div>
            
            ${r.notes?`
            <div class="mb-8">
              <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-gray-200">
                <span class="material-symbols-outlined ml-2 text-yellow-500">lightbulb</span>
                
              </h2>
              <div class="bg-yellow-50 dark:bg-yellow-900/20 p-6 rounded-xl">
                <p class="text-gray-700 dark:text-gray-300">${r.notes.replace(/\n/g,"<br>")}</p>
              </div>
            </div>
            `:""}
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 justify-center pt-6 border-t border-gray-200 dark:border-gray-700">
              <button onclick="downloadRecipe(0)" class="flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-slate-800 font-semibold rounded-lg transition-all shadow-md hover:shadow-lg">
                <span class="material-symbols-outlined">download</span>
                 
              </button>
              <button onclick="window.print()" class="flex items-center gap-2 px-6 py-3 bg-accent hover:bg-purple-400 text-slate-800 font-semibold rounded-lg transition-all shadow-md hover:shadow-lg">
                <span class="material-symbols-outlined">print</span>
                
              </button>
              <button onclick="shareRecipe(0)" class="flex items-center gap-2 px-6 py-3 bg-secondary hover:bg-pink-400 text-slate-800 font-semibold rounded-lg transition-all shadow-md hover:shadow-lg">
                <span class="material-symbols-outlined">share</span>
                
              </button>
            </div>
            
            <div class="text-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
              <p class="text-sm text-gray-500 dark:text-gray-400">
                        ?     !
              </p>
            </div>
          </div>
        </div>
      `}function Rs(r){if(!s[r]||!s[r].id){alert("      .");return}var o=(typeof window<"u"&&window.location&&window.location.origin?window.location.origin:"")+"/recipe/"+s[r].id;navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(o).then(function(){alert(`   !

       .`)}).catch(function(){alert(` :
`+o+`

   .`)}):alert(` :
`+o+`

   .`)}async function Ts(r){const o=s[r];if(!o||!o.id){alert("      .");return}const c=document.querySelectorAll(".action-btn");c.forEach(u=>u.disabled=!0);const f=document.createElement("div");f.id="regenerateLoading",f.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        gap: 2rem;
      `,f.innerHTML=`
        <img src="${L("chef-cooking.png")}" alt=" " style="width: 250px; max-width: 80vw; height: auto; border-radius: 1.5rem; box-shadow: 0 15px 50px rgba(0,0,0,0.5); animation: bounce 1s ease-in-out infinite;">
        <span style="color: white; font-size: 1.5rem; font-weight: 500; text-align: center;">  ...</span>
        <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>
      `,document.body.appendChild(f);try{const u=A+"/functions/v1/regenerate-image",p=await(await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+B},body:JSON.stringify({recipeId:o.id,recipeName:o.name,category:o.category})})).json();if(p.success&&p.image){let w=null;try{const S=await(await fetch(p.image)).blob(),k=S.type==="image/png"?"png":"jpg",I=new File([S],`regenerated.${k}`,{type:S.type});w=await pe(I)}catch(v){console.warn("Failed to upload regenerated image to Storage:",v)}w?(s[r].imagePath=w,s[r].image=null):s[r].image=p.image,await ae(s[r]),F(s),ge(r),alert("  !")}else alert("  : "+(p.error||"  "))}catch(u){console.error("Error regenerating image:",u),alert("  .  .")}finally{const u=document.getElementById("regenerateLoading");u&&u.remove(),c.forEach(g=>g.disabled=!1)}}async function $s(){var g,p,w;const r=(p=(g=document.getElementById("recipeName"))==null?void 0:g.value)==null?void 0:p.trim(),o=document.getElementById("category"),c=o&&o.value?o.value:"";if(!r){alert("      .");return}const f=e>=0&&((w=s[e])!=null&&w.id)?s[e].id:null,u=document.createElement("div");u.id="regenerateLoading",u.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        gap: 2rem;
      `,u.innerHTML=`
        <img src="${L("chef-cooking.png")}" alt=" " style="width: 250px; max-width: 80vw; height: auto; border-radius: 1.5rem; box-shadow: 0 15px 50px rgba(0,0,0,0.5); animation: bounce 1s ease-in-out infinite;">
        <span style="color: white; font-size: 1.5rem; font-weight: 500; text-align: center;">  ...</span>
        <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>
      `,document.body.appendChild(u);try{const v=A+"/functions/v1/regenerate-image",k=await(await fetch(v,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+B},body:JSON.stringify({recipeId:f,recipeName:r,category:c})})).json();if(k.success&&k.image){let I=null;try{const qe=await(await fetch(k.image)).blob(),He=qe.type==="image/png"?"png":"jpg",qt=new File([qe],`regenerated.${He}`,{type:qe.type});I=await pe(qt)}catch(te){console.warn("Failed to upload regenerated image to Storage:",te)}I?m={imagePath:I}:m={image:k.image};const E=document.getElementById("inlineImagePreview"),P=document.getElementById("inlinePreviewImg"),U=document.getElementById("inlineImageUploadContent"),D=document.querySelector(".image-upload-area"),ee=document.getElementById("image"),z=I?xe(I):k.image;P&&(P.src=z),E&&(E.style.display="block"),U&&(U.style.display="none"),D&&D.classList.add("has-image"),ee&&(ee.value=""),alert(" .       .")}else alert("  : "+(k.error||"  "))}catch(v){console.error("Error regenerating image:",v),alert("  .  .")}finally{const v=document.getElementById("regenerateLoading");v&&v.remove()}}window.regenerateImageForForm=$s;const yn={1:"",2:"",3:""};function vt(r){n=r>=1&&r<=3?r:2;const o=document.querySelectorAll("#formDifficultyBars .form-diff-bar"),c=document.getElementById("formDifficultyText");!o.length||!c||(o.forEach((f,u)=>{const g=u+1;f.classList.toggle("form-diff-empty",g>n)}),c.textContent=yn[n]||"")}function wt(r){document.querySelectorAll("#formRatingStars .form-star").forEach(c=>{const f=parseInt(c.dataset.rating,10);c.classList.toggle("filled",f<=r)})}function vn(){document.getElementById("formPopup").style.display="flex",document.getElementById("newCategory").style.display="none";const r=document.getElementById("toggleNewCategory");r&&(r.innerHTML='<span class="material-symbols-outlined">add</span>'),document.getElementById("category").style.display="block",document.getElementById("recipeForm").reset(),e=-1,t=0,vt(2),wt(0),h=null,m=null;const o=document.getElementById("category");o.innerHTML='<option value="" disabled selected> </option>';const c=["",""," ","","","","",""];c.forEach(w=>{const v=document.createElement("option");v.value=w,v.textContent=w,o.appendChild(v)}),[...new Set(s.map(w=>w.category))].forEach(w=>{if(w&&!c.includes(w)){const v=document.createElement("option");v.value=w,v.textContent=w,o.appendChild(v)}});const u=document.getElementById("ingredientsTableRows");u&&(u.querySelectorAll(".form-ingredient-row").forEach(w=>w.remove()),Et());const g=document.getElementById("inlineImagePreview"),p=document.getElementById("inlineImageUploadContent");g&&(g.style.display="none"),p&&(p.style.display="")}function bt(){document.getElementById("formPopup").style.display="none",document.getElementById("recipeForm").reset(),e=-1,m=null;const r=document.getElementById("imagePreviewContainer"),o=document.querySelector(".image-upload-area");r&&(r.style.display="none",document.getElementById("imagePreview").src=""),o&&o.classList.remove("has-image")}const _t=["","","",""];function Et(){const r=document.getElementById("ingredientsTableRows");if(!r)return;const o=document.createElement("div");o.className="form-ingredient-row",o.draggable=!0;const c=_t.map(f=>`<option>${f}</option>`).join("");o.innerHTML=`
        <span class="material-symbols-outlined ing-drag-handle">drag_indicator</span>
        <input type="number" class="ing-input ing-input-qty" placeholder="">
        <select class="ing-input ing-input-unit">${c}</select>
        <input type="text" class="ing-input ing-input-name" placeholder="   ">
        <button type="button" class="ing-remove-btn" onclick="removeIngredientRow(this)" title="">
          <span class="material-symbols-outlined">delete</span>
        </button>
      `,r.appendChild(o),o.querySelector(".ing-input-name").focus(),Ue()}window.addIngredientRow=Et;function As(r){const o=r.closest(".form-ingredient-row"),c=document.getElementById("ingredientsTableRows");c&&c.querySelectorAll(".form-ingredient-row").length>1&&o.remove(),Ue()}window.removeIngredientRow=As;function Ue(){const r=document.getElementById("ingredientsTableRows");if(!r)return;const o=r.querySelectorAll(".form-ingredient-row"),c=[];o.forEach(u=>{var v,S,k,I,E,P;const g=((S=(v=u.querySelector(".ing-input-name"))==null?void 0:v.value)==null?void 0:S.trim())||"",p=((I=(k=u.querySelector(".ing-input-unit"))==null?void 0:k.value)==null?void 0:I.trim())||"",w=((P=(E=u.querySelector(".ing-input-qty"))==null?void 0:E.value)==null?void 0:P.trim())||"";if(g||p||w){let U="";w&&(U+=w+" "),p&&(U+=p+" "),U+=g,c.push(U.trim())}});const f=document.getElementById("ingredients");f&&(f.value=c.join(`
`))}document.addEventListener("input",function(r){r.target.closest&&r.target.closest(".form-ingredient-row")&&Ue()}),document.addEventListener("change",function(r){r.target.closest&&r.target.closest(".form-ingredient-row")&&Ue()});function kt(r){const o=document.getElementById("ingredientsTableRows");if(!o)return;o.querySelectorAll(".form-ingredient-row").forEach(f=>f.remove());const c=(r||"").split(`
`).filter(f=>f.trim());if(c.length===0){Et();return}c.forEach(f=>{const u=document.createElement("div");u.className="form-ingredient-row",u.draggable=!0;const g=_t.map(w=>`<option>${w}</option>`).join("");u.innerHTML=`
          <span class="material-symbols-outlined ing-drag-handle">drag_indicator</span>
          <input type="number" class="ing-input ing-input-qty" placeholder="">
          <select class="ing-input ing-input-unit">${g}</select>
          <input type="text" class="ing-input ing-input-name" placeholder="   ">
          <button type="button" class="ing-remove-btn" onclick="removeIngredientRow(this)" title="">
            <span class="material-symbols-outlined">delete</span>
          </button>
        `;const p=f.trim().match(/^(\d+[\d\/\.]*\s*)?(\S+\s+)?(.+)$/);if(p){u.querySelector(".ing-input-qty").value=(p[1]||"").trim();const w=u.querySelector(".ing-input-unit"),v=(p[2]||"").trim();if(v&&_t.includes(v))w.value=v;else if(v){const S=document.createElement("option");S.value=v,S.textContent=v,w.appendChild(S),w.value=v}u.querySelector(".ing-input-name").value=(p[3]||"").trim()}else u.querySelector(".ing-input-name").value=f.trim();o.appendChild(u)})}function Ls(r){const o=r.target.files[0];if(o){const c=new FileReader;c.onload=function(f){const u=document.getElementById("imagePreviewContainer"),g=document.getElementById("imagePreview"),p=document.querySelector(".image-upload-area");u&&g&&(g.src=f.target.result,u.style.display="block",p&&p.classList.add("has-image"));const w=document.getElementById("inlineImagePreview"),v=document.getElementById("inlinePreviewImg"),S=document.getElementById("inlineImageUploadContent");w&&v&&(v.src=f.target.result,w.style.display="block",S&&(S.style.display="none"))},c.readAsDataURL(o)}}function Ps(r){const o=document.getElementById("confirmPopup");o.style.display="flex",o.setAttribute("data-index",r)}async function Os(){const o=document.getElementById("confirmPopup").getAttribute("data-index"),c=s[o],f=c==null?void 0:c.id;s.splice(o,1);try{f&&await Es(f),se(),Y(),F(s),It()}catch(u){console.error("Error deleting recipe:",u),alert("  .   .")}}function It(){document.getElementById("confirmPopup").style.display="none"}function js(r){const o=s[r],c=`
          <!DOCTYPE html>
          <html lang="he" dir="rtl">
          <head>
              <meta charset="UTF-8">
              <title>${o.name}</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      direction: rtl;
                      padding: 20px;
                      max-width: 400px;
                      margin: auto;
                      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                      border: 1px solid #ccc;
                      border-radius: 8px;
                  }
                  img {
                      max-width: 100%;
                      height: auto;
                      border-radius: 8px;
                      display: block;
                      margin: 10px auto;
                  }
                  ul {
                      padding-left: 20px;
                  }
              </style>
          </head>
          <body>
              <h1>${o.name} / ${o.source}</h1>
              ${o.image?`<img src="${o.image}" alt="  ${o.name}">`:""}
              <p><strong>:</strong> ${o.category}</p>
              <p><strong>:</strong></p>
              <ul class="ingredients-list">
                  ${o.ingredients.split(`
`).map(p=>`<li>${p}</li>`).join("")}
              </ul>
              <p><strong>:</strong></p>
              <ul class="instructions-list">
                  ${o.instructions.split(`
`).map(p=>`<li>${p}</li>`).join("")}
              </ul>
              ${o.videoUrl?`<div class="recipe-video">
                <iframe width="560" height="315" src="${tt(o.videoUrl)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
              </div>`:""}
              ${o.recipeLink?`<div class="recipe-link"><strong> :</strong><br><a href="${o.recipeLink}" target="_blank">${o.recipeLink}</a></div>`:""}
              ${o.notes?`<div class="recipe-notes"><strong>:</strong><br>${o.notes}</div>`:""}
          </body>
          </html>
      `,f=new Blob([c],{type:"text/html"}),u=URL.createObjectURL(f),g=document.createElement("a");g.href=u,g.download=`${o.name}.html`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(u),Ee()}async function Bs(r,o){s[r].rating=o;try{await ae(s[r]),ge(r),F(s)}catch(c){console.error("Error saving recipe rating:",c),alert("  .   .")}}function St(){let r="";for(let o=1;o<=5;o++)r+=`<span onclick="setFilterRating(${o})" id="filterStar${o}"></span>`;return r}function Us(r){for(let o=1;o<=5;o++){const c=document.getElementById(`filterStar${o}`);c&&(c.classList.remove("selected"),c.style.color="gray",c.textContent="")}if(r>0)for(let o=1;o<=r;o++){const c=document.getElementById(`filterStar${o}`);c&&(c.classList.add("selected"),c.style.color="green",c.textContent="")}Nt()}function Ds(){const r=document.getElementById("filterRating");return r?r.querySelectorAll(".selected").length:0}function Fs(){const r=document.getElementById("filterRating");if(!r)return;r.querySelectorAll("span").forEach(c=>{c.classList.remove("selected"),c.textContent="",c.style.color="gray"})}function wn(){document.getElementById("searchName").value="";const r=document.getElementById("searchIngredients");r&&(r.value="");const o=document.getElementById("searchPrepTime");o&&(o.value=""),i=null,Fs(),F(s),Y()}function Ms(){const r=new Date,o=r.getFullYear()+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0"),c="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s)),f=document.createElement("a");f.setAttribute("href",c),f.setAttribute("download",`--${o}.json`),document.body.appendChild(f),f.click(),f.remove()}async function bn(r){const o=r.target.files[0],c=new FileReader;c.onload=async function(f){try{const u=JSON.parse(f.target.result);let g=0;for(const p of u)p.id!==void 0&&delete p.id,(!p.image||p.image.trim()==="")&&(p.image=_e(p.category)),s.some(v=>{if(v.name!==p.name)return!1;const S=v.ingredients||"",k=p.ingredients||"";if(S!==k)return!1;const I=v.instructions||"",E=p.instructions||"";return I===E})||(s.push(p),g++);await fn(s),se(),Y(),F(s),alert(` ${g}   `)}catch(u){console.error("Error importing recipes:",u),alert("  .      .")}},c.readAsText(o)}function Ns(r){const o=r.target.files[0];if(o){const c=new FileReader;c.onload=function(f){Tesseract.recognize(f.target.result,"heb",{logger:u=>console.log(u)}).then(({data:{text:u}})=>{qs(u)})},c.readAsDataURL(o)}}function qs(r){const o=r.split(`
`);let c="";o.forEach(f=>{c+=f.trim()+`
`}),document.getElementById("ingredients").value=c.trim(),kt(c.trim())}function Hs(r){const o=s[r];if(navigator.share){const c=`
            <!DOCTYPE html>
            <html lang="he" dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>${o.name}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        direction: rtl;
                        padding: 20px;
                        max-width: 400px;
                        margin: auto;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                        border: 1px solid #ccc;
                        border-radius: 8px;
                    }
                    img {
                        max-width: 100%;
                        height: auto;
                        border-radius: 8px;
                        display: block;
                        margin: 10px auto;
                    }
                    ul {
                        padding-left: 20px;
                    }
                </style>
            </head>
            <body>
                <h1>${o.name} / ${o.source}</h1>
                ${o.image?`<img src="${o.image}" alt="  ${o.name}">`:""}
                <p><strong>:</strong> ${o.category}</p>
                <p><strong>:</strong></p>
                <ul class="ingredients-list">
                    ${o.ingredients.split(`
`).map(p=>`<li>${p}</li>`).join("")}
                </ul>
                <p><strong>:</strong></p>
                <ul class="instructions-list">
                    ${o.instructions.split(`
`).map(p=>`<li>${p}</li>`).join("")}
                </ul>
                ${o.videoUrl?`<div class="recipe-video">
                  <iframe width="560" height="315" src="${tt(o.videoUrl)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>`:""}
                ${o.recipeLink?`<div class="recipe-link"><strong> :</strong><br><a href="${o.recipeLink}" target="_blank">${o.recipeLink}</a></div>`:""}
                ${o.notes?`<div class="recipe-notes"><strong>:</strong><br>${o.notes}</div>`:""}
            </body>
            </html>
        `,f=new Blob([c],{type:"text/html"}),u=new File([f],`${o.name}.html`,{type:"text/html"}),g={title:o.name,text:`${o.name} - ${o.source}`,files:[u]};o.id&&typeof window<"u"&&window.location&&window.location.origin&&(g.url=window.location.origin+"/recipe/"+o.id),navigator.share(g).then(()=>{console.log("Shared successfully")}).catch(p=>{console.error("Error sharing:",p)})}else alert("    .")}function xt(r){const o=new Date().getTime(),c=14*24*60*60*1e3,f=r??null;(!f||o-f>c)&&zs(),a=setTimeout(async()=>{const u=await mt();xt(u.lastBackup)},c)}function zs(){const r=document.getElementById("backupReminder");r.style.display="flex"}async function Js(){const r=document.getElementById("backupReminder");r.style.display="none",await fe("lastBackup",new Date().getTime()),clearTimeout(a)}function Vs(){let r=`
          <!DOCTYPE html>
          <html lang="he" dir="rtl">
          <head>
              <meta charset="UTF-8">
              <title> </title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      direction: rtl;
                      padding: 20px;
                      margin: auto;
                      max-width: 800px;
                  }
                  h1 {
                      text-align: center;
                      margin-bottom: 40px;
                  }
                  .recipe {
                      border-bottom: 1px solid #ccc;
                      padding-bottom: 20px;
                      margin-bottom: 20px;
                  }
                  .recipe h2 {
                      margin-top: 0;
                  }
                  img {
                      max-width: 100%;
                      height: auto;
                      border-radius: 8px;
                      display: block;
                      margin: 10px auto;
                  }
                  ul {
                      padding-left: 20px;
                  }
              </style>
          </head>
          <body>
              <h1> </h1>
      `;s.forEach(u=>{r+=`
            <div class="recipe">
                <h2>${u.name} / ${u.source}</h2>
                ${u.image?`<img src="${u.image}" alt="  ${u.name}">`:""}
                <p><strong>:</strong> ${u.category}</p>
                <p><strong>:</strong></p>
                <ul>
                    ${u.ingredients.split(`
`).map(g=>`<li>${g}</li>`).join("")}
                </ul>
                <p><strong>:</strong></p>
                <ul>
                    ${u.instructions.split(`
`).map(g=>`<li>${g}</li>`).join("")}
                </ul>
                ${u.videoUrl?`<div class="recipe-video">
                  <iframe width="560" height="315" src="${tt(u.videoUrl)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>`:""}
                ${u.recipeLink?`<div class="recipe-link"><strong> :</strong><br><a href="${u.recipeLink}" target="_blank">${u.recipeLink}</a></div>`:""}
                ${u.notes?`<div class="recipe-notes"><strong>:</strong><br>${u.notes}</div>`:""}
            </div>
        `}),r+=`
          </body>
          </html>
      `;const o=new Blob([r],{type:"text/html"}),c=URL.createObjectURL(o),f=document.createElement("a");f.href=c,f.download=" .html",document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(c)}function De(r){document.documentElement.style.setProperty("--columns",r),document.querySelectorAll(".grid-option").forEach(c=>{c.classList.remove("active"),parseInt(c.dataset.cols)===r&&c.classList.add("active")}),fe("recipesPerRow",r)}function Ws(){const r=document.getElementById("grid-selector-menu");if(!r)return;const o=r.style.display!=="none";if(r.style.display=o?"none":"flex",!o){const c=f=>{f.target.closest(".grid-selector-wrapper")||(r.style.display="none",document.removeEventListener("click",c))};setTimeout(()=>{document.addEventListener("click",c)},0)}}function Ct(){document.querySelectorAll(".grid-option").forEach(o=>{o.addEventListener("click",()=>{const c=parseInt(o.dataset.cols);De(c),document.getElementById("grid-selector-menu").style.display="none"})})}function Rt(){["popup","formPopup","confirmPopup","aiChatOverlay"].forEach(o=>{const c=document.getElementById(o);c&&c.addEventListener("click",function(f){f.target===c&&(o==="popup"&&Ee(),o==="formPopup"&&bt(),o==="confirmPopup"&&It(),o==="aiChatOverlay"&&ke())})})}function Ks(r){return(r||[]).map(function(o){return{id:o.id,name:o.name||"",category:o.category||"",ingredients:(o.ingredients||"").slice(0,250),instructions:(o.instructions||"").slice(0,250),rating:o.rating??0}})}function Gs(r){return r?new Date(r).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"}):""}function Q(){const r=document.getElementById("aiChatMessages");if(!r)return;r.innerHTML="";const o=document.createElement("div");o.className="ai-chat-date-separator",o.innerHTML="<span></span>",r.appendChild(o),l.forEach(function(c,f){const u=document.createElement("div");if(u.className="ai-chat-msg-wrapper "+(c.role==="user"?"user":"assistant"),c.role!=="user"){const D=document.createElement("div");D.className="ai-chat-avatar chef",D.innerHTML='<img src="'+L("chef-serving.png")+'" alt="" class="chef-avatar-img">',u.appendChild(D)}const g=document.createElement("div");g.className="ai-chat-msg-content";const p=document.createElement("div");p.className="ai-chat-msg "+(c.role==="user"?"user":"assistant");const w=c.content||"";if(p.innerHTML='<p class="text-sm leading-relaxed">'+w.replace(/\n/g,"<br>")+"</p>",c.attachments&&c.attachments.length>0){const D=document.createElement("div");D.className="message-attachments",c.attachments.forEach(function(ee){if(ee.type==="image"){const z=document.createElement("div");z.className="message-attachment";const te=document.createElement("img");te.src=ee.data,te.alt=ee.name||"",te.onclick=function(){window.open(ee.data,"_blank")},z.appendChild(te),D.appendChild(z)}}),p.appendChild(D)}if(c.recipeCard){const D=document.createElement("div");D.className="ai-chat-recipe-card",D.innerHTML=`
            <img src="${c.recipeCard.image||"/assets/default-images/other/1.jpg"}" alt="${c.recipeCard.name}" onerror="this.src='/assets/default-images/other/1.jpg'">
            <div class="ai-chat-recipe-card-footer" onclick="viewRecipeFromChat('${c.recipeCard.id||""}')">
              <span>  </span>
              <span class="material-symbols-outlined">arrow_back</span>
            </div>
          `,p.appendChild(D)}if(c.suggestedRecipe&&typeof c.suggestedRecipe=="object"){var v=c.suggestedRecipe,S=v.image||"",k=(v.ingredients||"").replace(/\n/g,"<br>"),I=(v.instructions||"").replace(/\n/g,"<br>"),E=v.category||"",P=!!c.recipeAdded;const D=document.createElement("div");D.className="ai-chat-suggested-recipe-card",D.innerHTML=`
            ${S?`<div class="sr-card-image"><img src="${S}" alt="${v.name||""}" onerror="this.parentElement.style.display='none'"><div class="sr-card-badge">${E}</div></div>`:""}
            <div class="sr-card-body">
              <div class="sr-card-title">${v.name||""}</div>
              ${S?"":`<span class="sr-card-category">${E}</span>`}
              ${k?`
                <div class="sr-card-section open">
                  <div class="sr-card-section-header" onclick="this.parentElement.classList.toggle('open')">
                    <span><i class="fas fa-list-ul"></i> </span>
                    <i class="fas fa-chevron-down sr-card-chevron"></i>
                  </div>
                  <div class="sr-card-section-content">${k}</div>
                </div>`:""}
              ${I?`
                <div class="sr-card-section">
                  <div class="sr-card-section-header" onclick="this.parentElement.classList.toggle('open')">
                    <span><i class="fas fa-utensils"></i>  </span>
                    <i class="fas fa-chevron-down sr-card-chevron"></i>
                  </div>
                  <div class="sr-card-section-content">${I}</div>
                </div>`:""}
            </div>
            <div class="sr-card-actions">
              ${P?`
                <div class="sr-card-added"><i class="fas fa-check-circle"></i>   !</div>
              `:`
                <button class="sr-card-add-btn" onclick="addSuggestedRecipeDirectly(${f})">
                  <i class="fas fa-plus"></i>  
                </button>
                <button class="sr-card-edit-btn" onclick="editSuggestedRecipeFromMsg(${f})">
                  <i class="fas fa-edit"></i> 
                </button>
                <button class="sr-card-dismiss-btn" onclick="dismissSuggestedRecipe(${f})">
                  <i class="fas fa-times"></i>
                </button>
              `}
            </div>
          `,p.appendChild(D)}g.appendChild(p);const U=document.createElement("div");U.className="ai-chat-msg-time",U.textContent=Gs(c.timestamp||new Date),g.appendChild(U),u.appendChild(g),r.appendChild(u)}),r.scrollTo?requestAnimationFrame(function(){r.scrollTo({top:r.scrollHeight,behavior:"smooth"})}):r.scrollTop=r.scrollHeight}async function Ys(r){var o=l[r];if(!(!o||!o.suggestedRecipe)){var c=o.suggestedRecipe,f={insertSuggestedRecipe:!0,suggestedRecipe:{name:c.name||"",ingredients:c.ingredients||"",instructions:c.instructions||"",category:c.category||"",source:c.source||"   AI"}};try{var u=A+"/functions/v1/recipe-ai",g=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+B},body:JSON.stringify(f)}),p=g.ok?await g.json().catch(function(){return{}}):{};if(p&&p.insertedRecipeId){s=await pt(),Array.isArray(s)||(s=[]),o.recipeAdded=!0,o.addedRecipeId=p.insertedRecipeId,x=null,Q(),F(s),se(),Y();return}}catch(v){console.warn("Recipe-ai insert failed, falling back to local save:",v)}try{var w={name:c.name||"",source:c.source||"   AI",ingredients:c.ingredients||"",instructions:c.instructions||"",category:c.category||"",notes:null,rating:0,image:null,imagePath:null,recipeLink:null,videoUrl:null};await ae(w),s.push(w),o.recipeAdded=!0,o.addedRecipeId=w.id,x=null,Q(),F(s),se(),Y()}catch(v){console.error("Failed to add recipe directly:",v),alert("  : "+(v.message||v))}}}window.addSuggestedRecipeDirectly=Ys;function Xs(r){var o=l[r];!o||!o.suggestedRecipe||(ci(o.suggestedRecipe),o.suggestedRecipe=null,x=null,Q())}window.editSuggestedRecipeFromMsg=Xs;function Qs(r){var o=l[r];o&&(o.suggestedRecipe=null,x=null,Q())}window.dismissSuggestedRecipe=Qs,window.viewRecipeFromChat=function(r){if(!r)return;const o=s.find(c=>c.id===r);o&&(ke(),openPopup(o))};async function _n(){if(!R)return null;try{const{data:r,error:o}=await R.from("chat_conversations").insert({title:" "}).select("id").single();return o?(console.error("Error creating conversation:",o),null):r.id}catch(r){return console.error("Error creating conversation:",r),null}}async function En(){if(!R)return[];try{const r=new Date;r.setHours(r.getHours()-24);const o=r.toISOString(),{data:c,error:f}=await R.from("chat_conversations").select("id, title, updated_at, last_message_preview").gte("updated_at",o).order("updated_at",{ascending:!1}).limit(30);return f?(console.error("Error loading conversations:",f),[]):(Zs(),c||[])}catch(r){return console.error("Error loading conversations:",r),[]}}async function Zs(){if(R)try{const r=new Date;r.setHours(r.getHours()-24);const o=r.toISOString();await R.from("chat_messages").delete().lt("created_at",o),await R.from("chat_conversations").delete().lt("updated_at",o),console.log("Old conversations cleaned up")}catch(r){console.error("Error deleting old conversations:",r)}}async function ei(r){if(!R)return[];try{const{data:o,error:c}=await R.from("chat_messages").select("role, content, attachments").eq("conversation_id",r).order("created_at",{ascending:!0});return c?(console.error("Error loading messages:",c),[]):o||[]}catch(o){return console.error("Error loading messages:",o),[]}}async function kn(r,o,c,f){if(!(!R||!r))try{await R.from("chat_messages").insert({conversation_id:r,role:o,content:c,attachments:f||[]})}catch(u){console.error("Error saving message:",u)}}function ti(r){const o=new Date(r),f=new Date-o,u=Math.floor(f/6e4),g=Math.floor(f/36e5),p=Math.floor(f/864e5);return u<1?"":u<60?" "+u+" ":g<24?" "+g+" ":p<7?" "+p+" ":o.toLocaleDateString("he-IL")}function Tt(){const r=document.getElementById("aiChatHistorySelect");r&&(r.innerHTML='<option value="new">  -   ?</option>',b.forEach(function(o){const c=document.createElement("option");c.value=o.id,c.textContent=(o.title||"  ")+" ("+ti(o.updated_at)+")",o.id===y&&(c.selected=!0),r.appendChild(c)}))}async function ni(r){r==="new"?await In():await si(r)}window.loadSelectedConversation=ni;async function si(r){y=r,l=(await ei(r)).map(function(f){return{role:f.role,content:f.content,attachments:f.attachments||[]}}),Q(),Tt();const c=document.getElementById("aiChatHistory");c&&(c.style.display="none")}async function In(){y=await _n(),l=[],_=[],l.push({role:"assistant",content:"!      ?    ,      ,    .",timestamp:new Date}),b=await En(),Tt(),Q(),At();const r=document.getElementById("aiChatHistory");r&&(r.style.display="none");var o=document.getElementById("aiChatInput");o&&o.focus()}function ii(){const r=document.getElementById("aiChatHistory");r&&(r.style.display==="none"||!r.style.display?(r.style.display="block",loadChatHistory()):r.style.display="none")}function ri(){console.log("Chat menu clicked")}window.toggleChatMenu=ri;function oi(r){const o=r.target.files;if(!(!o||o.length===0)){for(let c=0;c<o.length;c++){const f=o[c];if(f.size>5*1024*1024){alert("   ( 5MB)");continue}const u=new FileReader;u.onload=function(g){ai(g.target.result,800,800,function(p){_.push({type:"image",data:p,name:f.name}),$t()})},u.readAsDataURL(f)}r.target.value=""}}function ai(r,o,c,f){const u=new Image;u.onload=function(){let g=u.width,p=u.height;if(g>o||p>c){const S=Math.min(o/g,c/p);g=Math.round(g*S),p=Math.round(p*S)}const w=document.createElement("canvas");w.width=g,w.height=p,w.getContext("2d").drawImage(u,0,0,g,p),f(w.toDataURL("image/jpeg",.85))},u.onerror=function(){f(r)},u.src=r}function $t(){const r=document.getElementById("aiChatAttachments");if(!r)return;if(_.length===0){r.style.display="none";return}r.style.display="flex",r.innerHTML="",_.forEach(function(c,f){const u=document.createElement("div");if(u.className="attachment-preview",c.type==="image"){const p=document.createElement("img");p.src=c.data,p.alt=c.name||"",u.appendChild(p)}const g=document.createElement("button");g.className="attachment-remove",g.innerHTML="&times;",g.onclick=function(){_.splice(f,1),$t()},u.appendChild(g),r.appendChild(u)});const o=document.getElementById("aiChatAttach");o&&o.classList.toggle("has-attachments",_.length>0)}function At(){_=[],$t()}async function li(){var r=document.getElementById("aiChatOverlay");r&&(r.style.display="flex"),y=await _n(),l=[],_=[],l.push({role:"assistant",content:"!     ,     ,      .   ?",timestamp:new Date}),b=await En(),Tt(),Q(),At();var o=document.getElementById("aiChatInput");o&&(o.value="",o.focus());var c=document.getElementById("aiChatSend");c&&(c.disabled=!1)}function ke(){d&&(d.abort(),d=null);var r=document.getElementById("aiChatOverlay");r&&(r.style.display="none")}function ci(r){if(!(!r||typeof r!="object")){ke(),vn(),document.getElementById("recipeName").value=r.name||"",document.getElementById("recipeSource").value=r.source||"",document.getElementById("ingredients").value=r.ingredients||"",kt(r.ingredients||""),document.getElementById("instructions").value=r.instructions||"";var o=r.category||"",c=document.getElementById("category");if(c){if(![].slice.call(c.options).some(function(u){return u.value===o})){var f=document.createElement("option");f.value=o,f.textContent=o,c.appendChild(f)}c.value=o}h=r.image||null}}async function di(){var r=document.getElementById("aiChatInput"),o=document.getElementById("aiChatSend"),c=r&&r.value?r.value.trim():"";if(!(!c&&_.length===0)){d&&d.abort(),d=new AbortController;var f={role:"user",content:c||(_.length>0?"[]":""),attachments:_.slice(),timestamp:new Date};l.push(f),y&&await kn(y,"user",f.content,f.attachments),r&&(r.value=""),At(),Q(),o&&(o.disabled=!0);var u=document.createElement("div");u.className="ai-chat-msg-wrapper assistant",u.id="aiChatLoading";var g=document.createElement("div");g.className="ai-chat-avatar chef",g.innerHTML='<img src="'+L("chef-typing.png")+'" alt=" " class="chef-avatar-img">';var p=document.createElement("div");p.className="ai-chat-msg-content";var w=document.createElement("div");w.className="ai-chat-msg assistant loading",w.setAttribute("aria-label","..."),w.innerHTML='<span class="typing-dots">...</span>',p.appendChild(w),u.appendChild(g),u.appendChild(p);var v=document.getElementById("aiChatMessages");v&&(v.appendChild(u),v.scrollTo({top:v.scrollHeight,behavior:"smooth"}));var S=A+"/functions/v1/recipe-ai";fetch(S,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+B},body:JSON.stringify({messages:l,recipes:Ks(s)}),signal:d.signal}).then(function(k){return k.json().then(function(I){return{res:k,data:I}})}).then(async function(k){var I=k.res,E=k.data;console.log("[AI Chat] Response data:",JSON.stringify(E,null,2));var P=document.getElementById("aiChatLoading");P&&P.remove(),o&&(o.disabled=!1);var U=E&&E.reply?E.reply:E&&E.error?E.error:"  .";!U&&I&&!I.ok&&(U="  ("+(I.status||"")+").   GEMINI_API_KEY -Supabase Secrets.");var D={role:"assistant",content:U,timestamp:new Date};E&&E.suggestedRecipe&&typeof E.suggestedRecipe=="object"&&(D.suggestedRecipe=E.suggestedRecipe),l.push(D),y&&await kn(y,"assistant",U,[]),Q();var ee=E&&Array.isArray(E.recipeIds)?E.recipeIds:[];if(E&&E.insertedRecipeId){x=null,ke(),s=await pt(),Array.isArray(s)||(s=[]),F(s),se(),Y();var z=s.findIndex(function(ze){return ze&&ze.id===E.insertedRecipeId});z>=0&&ge(z)}else if(E&&E.regenerateImageForRecipeId&&E.regeneratedImage){ke();var z=s.findIndex(function(nt){return nt&&nt.id===E.regenerateImageForRecipeId});if(z>=0){var te=null;try{var qe=await fetch(E.regeneratedImage),He=await qe.blob(),qt=He.type==="image/png"?"png":"jpg",Ri=new File([He],"ai-regenerated."+qt,{type:He.type});te=await pe(Ri)}catch(nt){console.warn("Failed to upload AI regenerated image to Storage:",nt)}te?(s[z].imagePath=te,s[z].image=null):s[z].image=E.regeneratedImage,await ae(s[z]),F(s),ge(z)}}else if(ee.length>0){var Ti=s.filter(function(ze){return ze.id&&ee.indexOf(ze.id)!==-1});F(Ti)}else E&&E.suggestedRecipe&&(x=E.suggestedRecipe,Q())}).catch(function(k){if(!(k&&k.name==="AbortError")){var I=document.getElementById("aiChatLoading");I&&I.remove(),o&&(o.disabled=!1),l.push({role:"assistant",content:"   -AI.    '.",timestamp:new Date}),Q()}})}}var Z=null,Lt=!1;function ui(){Lt?Pt():hi()}function hi(){var r=window.SpeechRecognition||window.webkitSpeechRecognition;if(!r){alert("     .  Chrome  Edge.");return}Z=new r,Z.lang="he-IL",Z.continuous=!0,Z.interimResults=!0,Z.onresult=function(o){for(var c="",f=0;f<o.results.length;f++)c+=o.results[f][0].transcript;document.getElementById("aiChatInput").value=c},Z.onerror=function(o){console.error("Voice recognition error:",o.error),o.error==="not-allowed"&&alert("    ."),Pt()},Z.onend=function(){Pt()},Z.start(),Lt=!0,Sn(!0)}function Pt(){Z&&(Z.stop(),Z=null),Lt=!1,Sn(!1)}function Sn(r){var o=document.getElementById("aiChatVoice");o&&(r?(o.classList.add("recording"),o.innerHTML='<i class="fas fa-stop"></i>'):(o.classList.remove("recording"),o.innerHTML='<i class="fas fa-microphone"></i>'))}function fi(){const r=document.getElementById("searchContainer"),o=document.querySelector(".header-filter-icon");if(!r)return;const c=window.getComputedStyle(r);r.style.display!=="none"&&c.display!=="none"?(r.style.display="none",o&&(o.style.color="#64748b",o.classList.remove("active"))):(r.style.display="block",o&&(o.style.color="var(--secondary)",o.classList.add("active")))}window.openFormPopup=vn,window.closeFormPopup=bt,window.previewFormImage=Ls,window.closePopup=Ee,window.editRecipe=xi,window.confirmDeleteRecipe=Ps,window.deleteRecipe=Os,window.closeConfirmPopup=It,window.downloadRecipe=js,window.shareRecipe=Hs,window.copyRecipeLink=Rs,window.closeBackupReminder=Js,window.filterRecipes=Nt,window.filterByCategory=$n,window.resetSearch=wn,window.rateRecipe=Bs,window.setFilterRating=Us,window.processOCR=Ns,window.exportRecipes=Ms,window.importRecipes=bn,window.downloadAllRecipes=Vs,window.toggleFilterPanel=fi,window.toggleGridSelector=Ws,window.setRecipesPerRow=De,window.openAiChat=li,window.closeAiChat=ke,window.sendAiMessage=di,window.toggleVoiceRecording=ui,window.regenerateImage=Ts,window.startNewConversation=In,window.toggleChatHistory=ii,window.handleChatFileSelect=oi;let Fe,Ie,Se,Me=!1,Ne=0,Ot=0;const jt=99,Bt=59,Ut=59;function xn(){const r=document.getElementById("timer-volume");if(!r)return 80;const o=parseFloat(r.value);return Number.isFinite(o)?Math.min(100,Math.max(0,o)):80}function gi(){const r=new(window.AudioContext||window.webkitAudioContext);Se=r;const o=r.createGain(),c=xn();o.gain.value=c/100*1.8,o.connect(r.destination);const f=[{freq:523.25,dur:.25},{freq:659.25,dur:.25},{freq:783.99,dur:.25},{freq:659.25,dur:.25},{freq:587.33,dur:.3},{freq:523.25,dur:.4},{freq:659.25,dur:.25},{freq:523.25,dur:.35}];let u=r.currentTime;f.forEach(p=>{const w=r.createOscillator(),v=r.createGain();w.type="sine",w.frequency.value=p.freq,v.gain.setValueAtTime(0,u),v.gain.linearRampToValueAtTime(.7,u+.02),v.gain.exponentialRampToValueAtTime(1e-4,u+p.dur),w.connect(v),v.connect(o),w.start(u),w.stop(u+p.dur),u+=p.dur+.05});const g=(u-r.currentTime+.1)*1e3;setTimeout(()=>{Se===r&&(Se=null),r.close()},g)}function Cn(){Se&&(Se.close(),Se=null)}function pi(r){const o=Math.floor(r/3600),c=Math.floor(r%3600/60),f=r%60;return`${o.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`}function Dt(){const r=document.getElementById("timer-seconds"),o=document.getElementById("timer-minutes"),c=document.getElementById("timer-hours");if(!r||!o||!c)return;let f=parseInt(r.value,10),u=parseInt(o.value,10),g=parseInt(c.value,10);f=Number.isFinite(f)?f:0,u=Number.isFinite(u)?u:0,g=Number.isFinite(g)?g:0,f=Math.max(0,f),u=Math.max(0,u),g=Math.max(0,g),f>Ut&&(u+=Math.floor(f/60),f=f%60),u>Bt&&(g+=Math.floor(u/60),u=u%60),g>jt&&(g=jt,u=Bt,f=Ut),r.value=f,o.value=u,c.value=g}function mi(){Dt();const r=document.getElementById("timer-seconds"),o=document.getElementById("timer-minutes"),c=document.getElementById("timer-hours");if(!r||!o||!c)return 0;const f=parseInt(r.value)||0,u=parseInt(o.value)||0;return(parseInt(c.value)||0)*3600+u*60+f}function yi(r){const o=document.getElementById("timer-seconds"),c=document.getElementById("timer-minutes"),f=document.getElementById("timer-hours");if(!o||!c||!f)return;const u=jt*3600+Bt*60+Ut,g=Math.min(Math.max(0,r),u),p=Math.floor(g/3600),w=Math.floor(g%3600/60),v=g%60;o.value=v,c.value=w,f.value=p}function vi(){const r=Me?Math.ceil(Ne/1e3):mi();if(r<=0)return;const o=document.getElementById("start-timer"),c=document.getElementById("pause-timer"),f=document.getElementById("stop-timer"),u=document.getElementById("timer-display"),g=document.getElementById("timer-mini-display"),p=document.getElementById("timer-widget");!o||!c||!f||!u||!p||(o.style.display="none",c.style.display="flex",f.style.display="flex",u.classList.add("active"),p.classList.add("is-running"),Ot=Date.now()+(Me?Ne:r*1e3),Me=!1,Ne=0,clearInterval(Fe),Fe=setInterval(()=>{const w=Date.now(),v=Math.max(0,Ot-w);if(v===0){clearInterval(Fe),u.classList.add("timer-ended");let k=0;const I=8;Ie=setInterval(()=>{k<I?(gi(),k++):(clearInterval(Ie),Ie=null,Cn(),o.style.display="flex",c.style.display="none",f.style.display="none",u.classList.remove("active"),u.classList.remove("timer-ended"),u.textContent="",g&&(g.textContent=""),p.classList.remove("is-running"))},4e3),o.style.display="flex",c.style.display="none",f.style.display="flex",u.classList.remove("active"),u.textContent="00:00:00",g&&(g.textContent="00:00"),p.classList.remove("is-running");return}const S=pi(Math.ceil(v/1e3));if(u.textContent=S,g){const k=Math.ceil(v/1e3);if(k>=3600)g.textContent=S;else{const I=Math.floor(k/60),E=k%60;g.textContent=`${I.toString().padStart(2,"0")}:${E.toString().padStart(2,"0")}`}}},1e3))}function wi(){const r=document.getElementById("start-timer"),o=document.getElementById("pause-timer"),c=document.getElementById("timer-display"),f=document.getElementById("timer-widget");!r||!o||!c||!f||(clearInterval(Fe),Me=!0,Ne=Math.max(0,Ot-Date.now()),r.style.display="flex",o.style.display="none",c.classList.remove("active"))}function bi(){const r=document.getElementById("start-timer"),o=document.getElementById("pause-timer"),c=document.getElementById("stop-timer"),f=document.getElementById("timer-display"),u=document.getElementById("timer-mini-display"),g=document.getElementById("timer-widget");!r||!o||!c||!f||!g||(clearInterval(Fe),Ie&&(clearInterval(Ie),Ie=null),Cn(),Me=!1,Ne=0,r.style.display="flex",o.style.display="none",c.style.display="none",f.classList.remove("active"),f.classList.remove("timer-ended"),f.textContent="",u&&(u.textContent=""),g.classList.remove("is-running"))}function _i(){const r=document.getElementById("timer-widget");if(!r)return;const o=r.classList.contains("is-open");o?r.classList.remove("is-open"):r.classList.add("is-open"),fe("timerVisible",!o)}function Ft(r){const o=document.getElementById("start-timer"),c=document.getElementById("pause-timer"),f=document.getElementById("stop-timer"),u=document.getElementById("timer-toggle-btn"),g=document.getElementById("timer-close-btn"),p=document.getElementById("timer-widget"),w=document.getElementById("timer-hours"),v=document.getElementById("timer-minutes"),S=document.getElementById("timer-seconds"),k=document.getElementById("timer-volume"),I=document.getElementById("timer-volume-value");if(!o||!c||!f||!u||!p||!w||!v||!S){console.warn("Timer elements not found, skipping timer initialization");return}const E=r&&r.timerVolume!=null?r.timerVolume:80;k&&(k.value=E,I&&(I.textContent=Math.round(E)+"%"),k.addEventListener("input",()=>{const P=Math.round(xn());I&&(I.textContent=P+"%"),fe("timerVolume",P),R||localStorage.setItem("timerVolume",String(P))})),u.addEventListener("click",_i),g&&g.addEventListener("click",()=>{p.classList.remove("is-open"),fe("timerVisible",!1)}),document.addEventListener("click",P=>{!p.contains(P.target)&&p.classList.contains("is-open")&&(p.classList.remove("is-open"),fe("timerVisible",!1))}),o.addEventListener("click",vi),c.addEventListener("click",wi),f.addEventListener("click",bi),document.querySelectorAll(".preset-btn").forEach(P=>{P.addEventListener("click",()=>{const U=parseInt(P.dataset.time);yi(U)})}),[w,v,S].forEach(P=>{P.addEventListener("input",Dt),P.addEventListener("change",Dt)})}function Ei(r,o,c,f){const u=new FileReader;u.onload=function(g){const p=new Image;p.onload=function(){let w=p.width,v=p.height;if(w>o||v>c){const E=Math.min(o/w,c/v);w*=E,v*=E}const S=document.createElement("canvas");S.width=w,S.height=v,S.getContext("2d").drawImage(p,0,0,w,v);const I=S.toDataURL(r.type);f(I)},p.src=g.target.result},u.readAsDataURL(r)}window.resizeImage=Ei;function Rn(r,o,c,f){return new Promise((u,g)=>{const p=new FileReader;p.onload=function(w){const v=new Image;v.onload=function(){let S=v.width,k=v.height;if(S>o||k>c){const P=Math.min(o/S,c/k);S*=P,k*=P}const I=document.createElement("canvas");I.width=S,I.height=k,I.getContext("2d").drawImage(v,0,0,S,k),I.toBlob(P=>{P?u(P):g(new Error("Failed to create blob"))},r.type,f)},v.onerror=()=>g(new Error("Failed to load image")),v.src=w.target.result},p.onerror=()=>g(new Error("Failed to read file")),p.readAsDataURL(r)})}async function pe(r){try{console.log(" [uploadImageToStorage] Starting upload..."),console.log("  - File name:",r.name),console.log("  - File size:",(r.size/1024).toFixed(2),"KB"),console.log("  - File type:",r.type),console.log("   Resizing image...");const o=await Rn(r,1200,1200,.85);console.log("   Image resized, new size:",(o.size/1024).toFixed(2),"KB");const c=crypto.randomUUID(),f=r.name.split(".").pop().toLowerCase(),g=`recipe-images/${`${c}.${f}`}`;console.log("   Storage path:",g),console.log("   UUID:",c),console.log("   Uploading to Supabase Storage...");const{data:p,error:w}=await R.storage.from("recipe-images").upload(g,o,{cacheControl:"31536000",upsert:!1});if(w)throw console.error("   Storage upload error:",w),w;return console.log("   Upload successful!"),console.log("  - Storage data:",p),console.log("  - Returning path:",g),g}catch(o){return console.error(" [uploadImageToStorage] Upload failed:",o),console.warn("   Will use default image instead"),null}}function xe(r,o={}){const c=typeof r=="string"&&r.length>60?r.substring(0,60)+"...":r;if(console.log(" [getImageUrl] Input:",c),!r)return console.log("   No image path provided, returning null"),null;if(r.startsWith("http")||r.startsWith("data:")||r.startsWith("/default-images/"))return console.log("   Already full URL, returning as-is"),r;const f=`${A}/storage/v1/object/public/recipe-images/${r}`;return console.log("   Built Storage URL:",f),f}function Tn(r){return""}async function Mt(){if(!R)return;const r=s.filter(o=>o&&o.id&&typeof o.image=="string"&&o.image.startsWith("data:")&&!o.imagePath);if(r.length!==0){console.log(` [migrateLegacyBase64ToStorage] Migrating ${r.length} recipe(s) with base64 images to Storage...`);for(const o of r)try{const f=await(await fetch(o.image)).blob(),u=f.type||(o.image.startsWith("data:image/png")?"image/png":"image/jpeg"),g=u==="image/png"?"png":"jpg",p=new File([f],`migrated-${o.id}.${g}`,{type:u}),w=await pe(p);w?(o.imagePath=w,o.image=null,await ae(o),Be(s),console.log(`   Migrated image for recipe "${o.name}" (id: ${o.id})`)):console.warn(`   Upload failed for recipe "${o.name}", keeping base64`)}catch(c){console.warn(`   Migration failed for recipe "${o.name}":`,c)}}}window.uploadImageToStorage=pe,window.resizeImageToBlob=Rn,window.getImageUrl=xe,window.getImageSrcSet=Tn,window.migrateLegacyBase64ToStorage=Mt;async function ki(r){console.log(" Debugging Recipe Image...");const o=s.find(c=>c.id===r);if(!o){console.error(" Recipe not found with ID:",r);return}if(console.log(" Recipe Info:",{id:o.id,name:o.name,category:o.category}),console.log(" Image Data:"),console.log("  - imagePath (Storage):",o.imagePath||"None"),console.log("  - image (legacy):",o.image?`${o.image.substring(0,50)}...`:"None"),o.imagePath){const c=xe(o.imagePath);console.log("  - Full URL:",c);try{const f=await fetch(c,{method:"HEAD"});console.log("  - Storage Status:",f.status,f.ok?" OK":" Failed"),f.ok||(console.error("  - Image file not found in Storage!"),console.log("  -  Solution: Use reuploadRecipeImage() to upload a new image"))}catch(f){console.error("  - Fetch Error:",f)}}else o.image&&o.image.startsWith("data:")?console.log("  - Using base64 image (legacy format)"):(console.log("  - Using default category image"),console.log("  - Default image:",_e(o.category)));console.log(" Debug complete")}async function Ii(r){const o=s.find(f=>f.id===r);if(!o){alert("  ");return}const c=document.createElement("input");c.type="file",c.accept="image/*",c.onchange=async f=>{const u=f.target.files[0];if(u)try{const g=document.createElement("div");g.id="upload-loading",g.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 10px; z-index: 10000; font-size: 18px;",g.textContent=" ...",document.body.appendChild(g);const p=await pe(u);if(!p||p.startsWith("data:"))throw new Error("Upload failed");o.imagePath=p,o.image=null,await ae(o),document.body.removeChild(g),F(s);const w=document.getElementById("popup");if(w&&w.style.display==="flex"){const v=s.findIndex(S=>S.id===r);v>=0&&ge(v)}alert("   !")}catch(g){console.error("Error reuploading image:",g);const p=document.getElementById("upload-loading");p&&document.body.removeChild(p),alert("   .   .")}},c.click()}window.debugRecipeImage=ki,window.reuploadRecipeImage=Ii;function Nt(){const r=document.getElementById("searchName").value.toLowerCase().trim(),o=document.getElementById("searchIngredients"),c=o?o.value.toLowerCase().trim():"",f=document.getElementById("searchPrepTime"),u=f&&parseInt(f.value)||0,g=Ds();if(!Array.isArray(s)||s.length===0){console.log("No recipes to filter"),F([]);return}if(!r&&!c&&!i&&!g&&!u){console.log("No filters active, showing all recipes:",s.length),F(s);return}const p=s.filter(w=>{if(!w||!w.name||!w.ingredients)return console.log("Skipping invalid recipe:",w),!1;const v=!r||w.name.toLowerCase().includes(r),S=!c||w.ingredients.toLowerCase().includes(c),k=!i||w.category&&w.category.trim()===i.trim(),I=!g||w.rating&&w.rating===g,E=!u||!w.preparationTime||w.preparationTime<=u;return v&&S&&k&&I&&E});console.log("Filtered recipes:",p.length,"out of",s.length),F(p)}function $n(r){i=r,Nt(),Y()}function se(){const r=document.getElementById("category"),o=r.value;r.innerHTML='<option value="" disabled selected> </option>';const c=["",""," ","","","","",""];c.forEach(u=>{const g=document.createElement("option");g.value=u,g.textContent=u,r.appendChild(g)}),[...new Set(s.map(u=>u.category))].forEach(u=>{if(u&&!c.includes(u)){const g=document.createElement("option");g.value=u,g.textContent=u,r.appendChild(g)}}),o&&(r.value=o)}function An(r){return bs[r]||"restaurant_menu"}function Ln(r){const o=hn[r]||"";return o?`category-icon-${o}`:""}function Pn(r){return hn[r]||"blue"}function Y(){const r=document.getElementById("categoryFilter");if(!r)return;const o=Si();r.innerHTML="";const c=document.createElement("button"),f=i===null,u=Ln(" "),g=Pn(" ");c.className=`category-button ${f?"active":""}`,c.setAttribute("data-category","all"),c.innerHTML=`
        <div class="glass-btn-3d category-bg-${g} ${f?"active":""}">
          <span class="material-symbols-outlined ${u}">${An(" ")}</span>
        </div>
        <span> </span>
      `,c.onclick=wn,r.appendChild(c),o.forEach(p=>{const w=document.createElement("button"),v=i===p;w.className=`category-button ${v?"active":""}`,w.setAttribute("data-category",p);const S=Ln(p),k=Pn(p);w.innerHTML=`
          <div class="glass-btn-3d category-bg-${k} ${v?"active":""}">
            <span class="material-symbols-outlined ${S}">${An(p)}</span>
          </div>
          <span>${p}</span>
        `,w.onclick=()=>$n(p),r.appendChild(w)})}function Si(){const r=s.map(o=>o.category);return[...new Set(r)]}function xi(r){if(!s[r])return;Ee(),m=null;const o=s[r];e=r;const c=document.querySelector(".form-popup-content h2");c&&(c.textContent=" "),document.getElementById("recipeName").value=o.name||"",document.getElementById("recipeSource").value=o.source||"",document.getElementById("ingredients").value=o.ingredients||"",kt(o.ingredients||""),document.getElementById("instructions").value=o.instructions||"",document.getElementById("preparationTime").value=o.preparationTime||"",document.getElementById("category").value=o.category||"",document.getElementById("notes").value=o.notes||"",document.getElementById("recipeVideo").value=o.videoUrl||"",document.getElementById("recipeLink").value=o.recipeLink||"",t=o.rating||0,wt(t),vt(o.difficulty??2);const f=document.getElementById("imagePreviewContainer"),u=document.getElementById("imagePreview"),g=document.querySelector(".image-upload-area"),p=document.getElementById("inlineImagePreview"),w=document.getElementById("inlinePreviewImg"),v=document.getElementById("inlineImageUploadContent");if(console.log(" [editRecipe] Displaying existing image for recipe:",o.name),console.log("  - imagePath:",o.imagePath),console.log("  - image (base64):",o.image?"exists":"none"),o.imagePath||o.image){let k;o.imagePath?(k=xe(o.imagePath),console.log("  - Using Storage URL:",k)):o.image&&(k=o.image,console.log("  - Using base64/external URL")),k?(u&&(u.src=k),f&&(f.style.display="block"),g&&g.classList.add("has-image"),w&&(w.src=k),p&&(p.style.display="block"),v&&(v.style.display="none"),console.log("   Image preview displayed successfully")):(console.log("   No valid image URL generated"),f&&(f.style.display="none"),g&&g.classList.remove("has-image"),p&&(p.style.display="none"),v&&(v.style.display=""))}else console.log("   No image for this recipe, using default"),f&&(f.style.display="none"),g&&g.classList.remove("has-image"),p&&(p.style.display="none"),v&&(v.style.display="");document.getElementById("formPopup").style.display="flex"}document.getElementById("recipeForm").addEventListener("submit",async function(r){r.preventDefault(),console.log(" [Form] Submit triggered");try{Ue();const o=document.getElementById("recipeName").value,c=document.getElementById("recipeSource").value,f=document.getElementById("ingredients").value,u=document.getElementById("instructions").value,g=document.getElementById("preparationTime").value?parseInt(document.getElementById("preparationTime").value):null,p=document.getElementById("notes").value,w=document.getElementById("recipeLink").value,v=document.getElementById("recipeVideo").value,S=document.getElementById("image").files[0];let k;const I=document.getElementById("newCategory");if(I.style.display==="block"){if(k=I.value.trim(),!k){alert("   ");return}}else if(k=document.getElementById("category").value,!k){alert("  ");return}if(!o){alert("   ");return}let E=null,P=null;if(S)try{if(console.log(" Uploading image to Storage..."),E=await pe(S),console.log(" Image uploaded to Storage:",E),!E||E.startsWith("data:"))throw new Error("Upload returned base64 instead of storage path")}catch(D){if(console.error(" Failed to upload to Storage:",D),!confirm(`   

    .
     .

   ?
(      )`))return;E=null,console.log(" Continuing with default image")}else e>=0&&!m?s[e].imagePath?E=s[e].imagePath:s[e].image&&(P=s[e].image):m?(m.imagePath?E=m.imagePath:m.image&&(P=m.image),m=null):h&&(h.startsWith("http")?E=h:P=h);h=null;const U={name:o,source:c,ingredients:f,instructions:u,category:k,notes:p,preparationTime:g,rating:t,difficulty:n,image:P,imagePath:E,recipeLink:w,videoUrl:v};e>=0?(s[e]={...s[e],...U},await ae(s[e]),console.log(" Recipe updated in DB"),e=-1):(s.push(U),await ae(U),console.log(" Recipe saved to DB with ID:",U.id)),F(s),se(),Y(),bt()}catch(o){console.error("Error in recipe form submit:",o),alert(": "+((o==null?void 0:o.message)||String(o)))}}),function(){const o=document.getElementById("formDifficultyBars");o&&o.addEventListener("click",function(f){const u=f.target.closest(".form-diff-bar");if(!u)return;const g=parseInt(u.dataset.level,10);g>=1&&g<=3&&vt(g)});const c=document.getElementById("formRatingStars");c&&c.addEventListener("click",function(f){const u=f.target.closest(".form-star");if(!u)return;const g=parseInt(u.dataset.rating,10);g>=1&&g<=5&&(t=g,wt(g))})}();function Ci(){const r=document.getElementById("category"),o=document.getElementById("newCategory"),c=document.getElementById("toggleNewCategory");o.style.display==="none"?(r.style.display="none",o.style.display="block",c&&(c.innerHTML="  "),r.required=!1,o.required=!0):(r.style.display="block",o.style.display="none",c&&(c.innerHTML='<span class="material-symbols-outlined">add</span>'),r.required=!0,o.required=!1,o.value="")}window.toggleCategoryInput=Ci})();export{ta as g};
